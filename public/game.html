<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Red Strong Tetris</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-light: #e8f4fc;
            --bg-dark: #1a237e;
            --accent-red: #e31e24;
            --accent-yellow: #ffd700;
            --glass: rgba(255,255,255,0.9);
        }
        
        /* Light Mode */
        body.light-mode {
            background: linear-gradient(180deg, #e8f4fc 0%, #cce5f5 50%, #b8daf0 100%);
        }
        body.light-mode .game-background {
            background: linear-gradient(180deg, #e8f4fc 0%, #cce5f5 50%, #b8daf0 100%);
        }
        body.light-mode .bg-stars { opacity: 0; }
        body.light-mode .bg-wave { opacity: 0.5; }
        body.light-mode .bg-wave::before { 
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='rgba(26,35,126,0.15)' d='M0,192L48,197.3C96,203,192,213,288,229.3C384,245,480,267,576,250.7C672,235,768,181,864,181.3C960,181,1056,235,1152,234.7C1248,235,1344,181,1392,154.7L1440,128L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z'%3E%3C/path%3E%3C/svg%3E") repeat-x;
            background-size: 50% 100%;
        }
        body.light-mode .bg-glow.red { background: rgba(227,30,36,0.1); }
        body.light-mode .bg-glow.yellow { background: rgba(255,215,0,0.08); }
        body.light-mode .bg-glow.blue { background: rgba(26,35,126,0.08); }
        
        /* Light Mode - Home Screen */
        body.light-mode .home-title { color: var(--bg-dark); text-shadow: none; }
        body.light-mode .home-subtitle { color: var(--accent-red); font-weight: 600; }
        body.light-mode .stat-card { background: rgba(255,255,255,0.9); border: 1px solid rgba(0,0,0,0.1); box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        body.light-mode .stat-card-value { color: var(--accent-red); }
        body.light-mode .stat-card-label { color: #666; }
        body.light-mode .home-card { background: rgba(255,255,255,0.95); border: 1px solid rgba(0,0,0,0.1); box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        body.light-mode .form-group label { color: var(--bg-dark); }
        body.light-mode .form-input { background: #fff; border-color: #ddd; color: #333; }
        body.light-mode .form-input::placeholder { color: #999; }
        body.light-mode .section-title { color: var(--bg-dark); }
        body.light-mode .lb-tab { background: rgba(26,35,126,0.1); color: var(--bg-dark); }
        body.light-mode .leaderboard-list { background: rgba(255,255,255,0.95); border: 1px solid rgba(0,0,0,0.1); }
        body.light-mode .leaderboard-item { border-bottom-color: rgba(0,0,0,0.08); }
        body.light-mode .player-name { color: var(--bg-dark); }
        body.light-mode .player-province { color: #777; }
        body.light-mode .player-score { color: var(--accent-red); }
        body.light-mode .rank { background: #f0f0f0; color: #555; }
        body.light-mode .achievement-badge { background: rgba(255,255,255,0.9); border: 1px solid rgba(0,0,0,0.1); }
        body.light-mode .achievement-badge .name { color: #555; }
        body.light-mode .home-footer { color: #777; }
        body.light-mode .home-footer span { color: var(--accent-red); }
        body.light-mode .leaderboard-live-indicator { color: #777; }
        body.light-mode .mode-toggle-btn { background: rgba(26,35,126,0.1); border-color: rgba(26,35,126,0.2); }
        
        /* Light Mode - Game Screen */
        body.light-mode .game-wrapper { background: transparent; }
        body.light-mode .stat-box { background: rgba(255,255,255,0.9); }
        body.light-mode .stat-label { color: #666; }
        body.light-mode .stat-value { color: var(--bg-dark); }
        body.light-mode .energy-bar { background: rgba(255,255,255,0.9); }
        body.light-mode .game-board-wrapper { background: rgba(255,255,255,0.95); }
        body.light-mode .control-btn { background: rgba(255,255,255,0.9); }
        body.light-mode .timer-display { color: var(--bg-dark); }
        body.light-mode .score-display { background: rgba(255,255,255,0.9); }
        body.light-mode .score-value { color: var(--bg-dark); }
        body.light-mode .panel-box { background: rgba(255,255,255,0.9); }
        
        /* Dark Mode (Default) */
        body.dark-mode {
            background: linear-gradient(180deg, #0a0a1a 0%, #1a1a3a 50%, #0d0d2a 100%);
        }
        body.dark-mode .game-background {
            background: linear-gradient(180deg, #0a0a1a 0%, #1a1a3a 50%, #0d0d2a 100%);
        }
        
        html, body { height: 100%; overflow: hidden; font-family: 'Cairo', sans-serif; background: linear-gradient(180deg, #0a0a1a 0%, #1a1a3a 50%, #0d0d2a 100%); touch-action: manipulation; -webkit-user-select: none; user-select: none; }
        
        /* Animated Background */
        .game-background {
            position: fixed;
            inset: 0;
            z-index: 0;
            overflow: hidden;
            background: linear-gradient(180deg, #0a0a1a 0%, #1a1a3a 50%, #0d0d2a 100%);
        }
        .bg-stars {
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(2px 2px at 20px 30px, #fff, transparent),
                radial-gradient(2px 2px at 40px 70px, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 90px 40px, #fff, transparent),
                radial-gradient(2px 2px at 160px 120px, rgba(255,255,255,0.9), transparent),
                radial-gradient(1px 1px at 230px 80px, #fff, transparent);
            background-size: 250px 200px;
            animation: twinkle 5s ease-in-out infinite;
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        .bg-wave {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 200%;
            height: 200px;
            background: linear-gradient(180deg, transparent, rgba(227,30,36,0.1));
            animation: waveMove 8s linear infinite;
        }
        .bg-wave::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='rgba(227,30,36,0.15)' d='M0,192L48,197.3C96,203,192,213,288,229.3C384,245,480,267,576,250.7C672,235,768,181,864,181.3C960,181,1056,235,1152,234.7C1248,235,1344,181,1392,154.7L1440,128L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z'%3E%3C/path%3E%3C/svg%3E") repeat-x;
            background-size: 50% 100%;
        }
        @keyframes waveMove {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        .bg-glow {
            position: absolute;
            width: 300px;
            height: 300px;
            border-radius: 50%;
            filter: blur(80px);
            animation: glowPulse 4s ease-in-out infinite;
        }
        .bg-glow.red { background: rgba(227,30,36,0.3); top: 20%; left: 10%; }
        .bg-glow.yellow { background: rgba(255,215,0,0.2); bottom: 20%; right: 10%; animation-delay: 2s; }
        .bg-glow.blue { background: rgba(0,188,212,0.2); top: 50%; left: 50%; transform: translate(-50%, -50%); animation-delay: 1s; }
        @keyframes glowPulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.3); opacity: 0.8; }
        }
        
        /* Particle Canvas for Game Effects */
        #particle-canvas {
            position: fixed;
            inset: 0;
            z-index: 1000;
            pointer-events: none;
        }
        
        /* Loading Screen */
        .loading-screen { position: fixed; inset: 0; background: linear-gradient(180deg, #1a237e 0%, #0d1442 50%, #050a20 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 99999; transition: opacity 0.8s, visibility 0.8s; overflow: hidden; }
        .loading-screen.hidden { opacity: 0; visibility: hidden; }
        .loading-particles { position: absolute; inset: 0; overflow: hidden; }
        .particle { position: absolute; background: var(--accent-yellow); border-radius: 50%; animation: floatParticle 4s ease-in-out infinite; }
        @keyframes floatParticle { 0%, 100% { transform: translateY(0); opacity: 0.3; } 50% { transform: translateY(-100px); opacity: 0.8; } }
        .loading-can-container { position: relative; width: 180px; height: 300px; display: flex; align-items: center; justify-content: center; }
        .can-glow { position: absolute; width: 200px; height: 200px; background: radial-gradient(circle, rgba(227,30,36,0.4) 0%, transparent 70%); border-radius: 50%; animation: pulseGlow 2s ease-in-out infinite; }
        @keyframes pulseGlow { 0%, 100% { transform: scale(1); opacity: 0.5; } 50% { transform: scale(1.3); opacity: 0.8; } }
        .loading-can { width: 100%; max-width: 140px; position: relative; z-index: 2; animation: canFloat 3s ease-in-out infinite; filter: drop-shadow(0 30px 50px rgba(0,0,0,0.6)); }
        @keyframes canFloat { 0%, 100% { transform: translateY(0) rotate(-3deg); } 50% { transform: translateY(-25px) rotate(3deg); } }
        .energy-ring { position: absolute; border: 3px solid var(--accent-red); border-radius: 50%; animation: ringExpand 2s ease-out infinite; }
        .energy-ring:nth-child(1) { animation-delay: 0s; }
        .energy-ring:nth-child(2) { animation-delay: 0.5s; }
        .energy-ring:nth-child(3) { animation-delay: 1s; }
        @keyframes ringExpand { 0% { width: 100px; height: 100px; opacity: 0.8; } 100% { width: 300px; height: 300px; opacity: 0; } }
        .loading-title { font-family: 'Orbitron', sans-serif; font-size: 2.5rem; margin: 30px 0 10px; text-align: center; }
        .loading-title .red { color: #e31e24; text-shadow: 0 0 20px rgba(227,30,36,0.8); }
        .loading-title .strong { color: #fff; text-shadow: 0 0 20px rgba(255,255,255,0.5); }
        .loading-subtitle { color: var(--accent-yellow); font-size: 1.2rem; margin-bottom: 40px; letter-spacing: 3px; }
        .loading-bar-bg { width: 280px; height: 12px; background: rgba(255,255,255,0.15); border-radius: 10px; overflow: hidden; border: 2px solid rgba(255,255,255,0.2); }
        .loading-bar-fill { height: 100%; background: linear-gradient(90deg, var(--accent-red), var(--accent-yellow), var(--accent-red)); background-size: 200% 100%; width: 0%; animation: loadProgress 2.5s ease-out forwards, shimmer 1.5s linear infinite; border-radius: 10px; }
        @keyframes loadProgress { 0% { width: 0%; } 50% { width: 70%; } 100% { width: 100%; } }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .loading-text { color: rgba(255,255,255,0.7); font-size: 0.9rem; margin-top: 20px; }
        .tetris-blocks { position: absolute; bottom: 30px; display: flex; gap: 8px; }
        .tetris-block { width: 25px; height: 25px; border-radius: 5px; animation: blockBounce 1.5s ease-in-out infinite; }
        .tetris-block:nth-child(1) { background: #00bcd4; animation-delay: 0s; }
        .tetris-block:nth-child(2) { background: #ff9800; animation-delay: 0.1s; }
        .tetris-block:nth-child(3) { background: #4caf50; animation-delay: 0.2s; }
        .tetris-block:nth-child(4) { background: #e31e24; animation-delay: 0.3s; }
        .tetris-block:nth-child(5) { background: #ffd700; animation-delay: 0.4s; }
        .tetris-block:nth-child(6) { background: #9c27b0; animation-delay: 0.5s; }
        @keyframes blockBounce { 0%, 100% { transform: translateY(0) scale(1); } 50% { transform: translateY(-15px) scale(1.1); } }
        
        /* Screens */
        .screen { display: none; height: 100%; overflow-y: auto; position: relative; z-index: 10; }
        .screen.active { display: flex; flex-direction: column; }
        
        /* Prize Section */
        .prize-section {
            width: 100%;
            max-width: 400px;
            margin-bottom: 20px;
        }
        .prize-card {
            background: linear-gradient(135deg, rgba(227,30,36,0.15), rgba(255,215,0,0.1));
            border: 2px solid rgba(227,30,36,0.3);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .prize-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: prizeShine 3s infinite;
        }
        @keyframes prizeShine {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }
        .prize-badge {
            display: inline-block;
            background: linear-gradient(135deg, var(--accent-red), #ff4444);
            color: white;
            padding: 8px 20px;
            border-radius: 30px;
            font-size: 0.9rem;
            font-weight: 700;
            margin-bottom: 15px;
            animation: pulseBadge 2s infinite;
        }
        @keyframes pulseBadge {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .prize-image-wrapper {
            width: 150px;
            height: 150px;
            margin: 0 auto 15px;
            border-radius: 20px;
            overflow: hidden;
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .prize-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .prize-name {
            color: var(--accent-yellow);
            font-size: 1.3rem;
            margin-bottom: 8px;
            text-shadow: 0 2px 10px rgba(255,215,0,0.3);
        }
        .prize-desc {
            color: rgba(255,255,255,0.8);
            font-size: 0.9rem;
        }
        body.light-mode .prize-card {
            background: linear-gradient(135deg, rgba(227,30,36,0.1), rgba(26,35,126,0.05));
            border-color: rgba(227,30,36,0.2);
        }
        body.light-mode .prize-name { color: var(--accent-red); text-shadow: none; }
        body.light-mode .prize-desc { color: #666; }
        
        /* Announcements Section - Premium Design */
        .announcements-section {
            width: 100%;
            max-width: 400px;
            margin-bottom: 20px;
        }
        .announcements-slider {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .announcement-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 16px;
            padding: 0;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        .announcement-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border-color: rgba(255,215,0,0.3);
        }
        .announcement-card.has-image {
            display: flex;
            flex-direction: row;
        }
        .announcement-card .ann-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            flex-shrink: 0;
        }
        .announcement-card .ann-content {
            padding: 15px;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .announcement-card .ann-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 0.7rem;
            padding: 3px 10px;
            border-radius: 20px;
            width: fit-content;
            margin-bottom: 8px;
        }
        .announcement-card .ann-badge.urgent {
            background: linear-gradient(135deg, #e31e24, #ff4444);
            color: white;
        }
        .announcement-card .ann-badge.info {
            background: linear-gradient(135deg, #2196f3, #03a9f4);
            color: white;
        }
        .announcement-card .ann-badge.promo {
            background: linear-gradient(135deg, #ffd700, #ffb300);
            color: #333;
        }
        .announcement-card .ann-badge.new {
            background: linear-gradient(135deg, #4caf50, #8bc34a);
            color: white;
        }
        .announcement-card .ann-title {
            color: white;
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 5px;
            line-height: 1.3;
        }
        .announcement-card .ann-text {
            color: rgba(255,255,255,0.75);
            font-size: 0.85rem;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .announcement-card .ann-arrow {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255,255,255,0.4);
            font-size: 1.2rem;
            transition: all 0.3s;
        }
        .announcement-card:hover .ann-arrow {
            color: var(--accent-yellow);
            left: 10px;
        }
        /* Full width announcement without image */
        .announcement-card.no-image .ann-content {
            padding: 15px 40px 15px 15px;
        }
        /* Banner style for single important announcement */
        .announcement-banner {
            background: linear-gradient(135deg, var(--accent-red), #ff4444);
            border-radius: 12px;
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            animation: bannerPulse 2s infinite;
        }
        @keyframes bannerPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(227,30,36,0.4); }
            50% { box-shadow: 0 0 0 10px rgba(227,30,36,0); }
        }
        .announcement-banner .banner-icon {
            font-size: 1.5rem;
            animation: bellShake 1s infinite;
        }
        @keyframes bellShake {
            0%, 100% { transform: rotate(0); }
            25% { transform: rotate(15deg); }
            75% { transform: rotate(-15deg); }
        }
        .announcement-banner .banner-text {
            flex: 1;
            color: white;
            font-size: 0.9rem;
            font-weight: 600;
        }
        .announcement-banner .banner-btn {
            background: white;
            color: var(--accent-red);
            border: none;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
        }
        body.light-mode .announcement-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
            border-color: rgba(0,0,0,0.1);
        }
        body.light-mode .announcement-card .ann-title { color: #333; }
        body.light-mode .announcement-card .ann-text { color: #666; }
        body.light-mode .announcement-card .ann-arrow { color: rgba(0,0,0,0.3); }
        body.light-mode .announcement-card:hover .ann-arrow { color: var(--accent-red); }
        
        /* Announcement Slider */
        .announcement-slide {
            display: none;
            animation: slideIn 0.4s ease;
        }
        .announcement-slide.active {
            display: block;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .announcement-dots {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 12px;
        }
        .announcement-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            cursor: pointer;
            transition: all 0.3s;
        }
        .announcement-dot:hover {
            background: rgba(255,255,255,0.5);
        }
        .announcement-dot.active {
            background: var(--accent-yellow);
            width: 24px;
            border-radius: 10px;
        }
        body.light-mode .announcement-dot {
            background: rgba(0,0,0,0.2);
        }
        body.light-mode .announcement-dot.active {
            background: var(--accent-red);
        }
        
        /* Home Screen */
        .home-screen { align-items: center; padding: 20px; padding-bottom: 100px; background: transparent; }
        .home-header { display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 400px; margin-bottom: 20px; }
        .home-logo-small { height: 40px; }
        .header-buttons { display: flex; gap: 8px; align-items: center; }
        .mode-toggle-btn { width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.3); font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s; }
        .mode-toggle-btn:hover { background: rgba(255,255,255,0.3); transform: scale(1.1); }
        body.light-mode .mode-toggle-btn { background: rgba(26,35,126,0.1); border-color: rgba(26,35,126,0.2); }
        .check-win-btn { padding: 10px 20px; background: linear-gradient(135deg, var(--accent-yellow), #ffb300); border: none; border-radius: 20px; color: var(--bg-dark); font-family: inherit; font-weight: 700; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 5px; box-shadow: 0 5px 15px rgba(255,215,0,0.3); }
        .home-hero { text-align: center; margin-bottom: 20px; }
        
        /* Improved Can Logo */
        .home-logo { 
            width: 150px; 
            filter: drop-shadow(0 15px 35px rgba(227,30,36,0.4)) drop-shadow(0 5px 15px rgba(0,0,0,0.3)); 
            animation: heroFloat 3s ease-in-out infinite;
            transition: filter 0.3s;
        }
        body.light-mode .home-logo {
            filter: drop-shadow(0 15px 35px rgba(26,35,126,0.3)) drop-shadow(0 5px 15px rgba(0,0,0,0.2));
        }
        @keyframes heroFloat { 0%, 100% { transform: translateY(0) rotate(-2deg); } 50% { transform: translateY(-10px) rotate(2deg); } }
        
        /* Contact Section */
        .contact-section {
            width: 100%;
            max-width: 400px;
            margin-top: 25px;
        }
        .contact-card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 15px;
        }
        body.light-mode .contact-card {
            background: rgba(255,255,255,0.95);
            border: 1px solid rgba(0,0,0,0.1);
        }
        .contact-title {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: 700;
            color: #ff6b9d;
            font-size: 1.1rem;
            margin-bottom: 15px;
        }
        body.light-mode .contact-title {
            color: var(--accent-red);
        }
        .contact-item {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 10px;
            padding: 12px 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            margin-bottom: 10px;
            color: #fff;
            text-decoration: none;
            transition: all 0.3s;
        }
        body.light-mode .contact-item {
            background: rgba(26,35,126,0.08);
            color: var(--bg-dark);
        }
        .contact-item:hover {
            background: rgba(255,255,255,0.2);
            transform: translateX(-5px);
        }
        body.light-mode .contact-item:hover {
            background: rgba(26,35,126,0.15);
        }
        .contact-item .icon {
            font-size: 1.3rem;
        }
        .contact-item .text {
            font-size: 0.95rem;
            direction: ltr;
        }
        
        /* Social Section */
        .social-card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            padding: 20px;
        }
        body.light-mode .social-card {
            background: rgba(255,255,255,0.95);
            border: 1px solid rgba(0,0,0,0.1);
        }
        .social-title {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: 700;
            color: #4fc3f7;
            font-size: 1.1rem;
            margin-bottom: 15px;
        }
        body.light-mode .social-title {
            color: var(--bg-dark);
        }
        .social-icons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        .social-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: #fff;
            text-decoration: none;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .social-btn:hover {
            transform: translateY(-5px) scale(1.1);
        }
        .social-btn.whatsapp { background: linear-gradient(135deg, #25d366, #128c7e); }
        .social-btn.instagram { background: linear-gradient(135deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); }
        .social-btn.facebook { background: linear-gradient(135deg, #1877f2, #0d65d9); }
        
        /* Brand Title - Red Strong */
        .brand-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5rem;
            font-weight: 900;
            margin: 15px 0 5px;
            display: flex;
            justify-content: center;
            gap: 10px;
            animation: heroFloat 3s ease-in-out infinite;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .brand-red {
            color: #e31e24 !important; /* Always red */
        }
        .brand-strong {
            color: #fff; /* White in dark mode (default) */
        }
        body.light-mode .brand-strong {
            color: #1a1a2e !important; /* Black in light mode */
        }
        body.light-mode .brand-title {
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        
        /* Colorful TETRIS Title (kept for reference) */
        .tetris-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5rem;
            font-weight: 900;
            margin: 15px 0 5px;
            display: flex;
            justify-content: center;
            gap: 2px;
            animation: heroFloat 3s ease-in-out infinite;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        body.light-mode .tetris-title {
            color: #1a1a2e;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        .tetris-title span {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 6px;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.3);
            animation: letterBounce 2s ease-in-out infinite;
        }
        .letter-t1 { background: linear-gradient(180deg, #ff4444, #cc0000); color: #fff; animation-delay: 0s; }
        .letter-e { background: linear-gradient(180deg, #ff9944, #ff6600); color: #fff; animation-delay: 0.1s; }
        .letter-t2 { background: linear-gradient(180deg, #ffdd44, #ffcc00); color: #333; animation-delay: 0.2s; }
        .letter-r { background: linear-gradient(180deg, #44dd44, #00aa00); color: #fff; animation-delay: 0.3s; }
        .letter-i { background: linear-gradient(180deg, #44ddff, #00aaff); color: #fff; animation-delay: 0.4s; }
        .letter-s { background: linear-gradient(180deg, #dd44ff, #aa00ff); color: #fff; animation-delay: 0.5s; }
        
        @keyframes letterBounce {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-5px) scale(1.05); }
        }
        
        .home-title { font-family: 'Orbitron', sans-serif; font-size: 2rem; color: #fff; margin: 15px 0 5px; text-shadow: 0 0 20px rgba(227,30,36,0.5); }
        .home-subtitle { color: rgba(255,255,255,0.9); font-size: 1rem; font-weight: 600; }
        
        /* Stats Cards */
        .stats-cards { display: flex; gap: 10px; width: 100%; max-width: 400px; margin-bottom: 20px; }
        .stat-card { flex: 1; background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); border-radius: 15px; padding: 15px; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.2); }
        .stat-card-icon { font-size: 1.5rem; margin-bottom: 5px; }
        .stat-card-value { font-family: 'Orbitron', sans-serif; font-size: 1.3rem; font-weight: 900; color: var(--accent-yellow); }
        .stat-card-label { font-size: 0.7rem; color: rgba(255,255,255,0.7); font-weight: 600; }
        .stat-card-label { font-size: 0.7rem; color: #666; }
        
        /* Form Card */
        .home-card { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); border-radius: 25px; padding: 25px; width: 100%; max-width: 400px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        .form-group { margin-bottom: 15px; text-align: right; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 600; color: rgba(255,255,255,0.9); font-size: 0.9rem; }
        .form-input { width: 100%; padding: 14px 16px; border: 2px solid rgba(255,255,255,0.2); border-radius: 12px; font-family: inherit; font-size: 1rem; background: rgba(255,255,255,0.1); color: #fff; }
        .form-input:focus { outline: none; border-color: var(--accent-red); box-shadow: 0 0 0 4px rgba(227,30,36,0.3); }
        .form-input::placeholder { color: rgba(255,255,255,0.5); }
        .play-btn { width: 100%; padding: 16px; background: linear-gradient(135deg, var(--accent-red), #ff4444); border: none; border-radius: 15px; color: white; font-family: inherit; font-size: 1.2rem; font-weight: 700; cursor: pointer; margin-top: 10px; box-shadow: 0 8px 25px rgba(227,30,36,0.5); }
        
        /* Leaderboard */
        .leaderboard-section { width: 100%; max-width: 400px; margin-top: 25px; }
        .leaderboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 10px; }
        .section-title { display: flex; align-items: center; gap: 8px; font-weight: 700; color: #fff; font-size: 1rem; margin: 0; }
        .leaderboard-tabs { display: flex; gap: 5px; }
        .lb-tab { padding: 6px 12px; border: none; background: rgba(255,255,255,0.1); border-radius: 20px; font-size: 0.75rem; font-weight: 600; color: rgba(255,255,255,0.8); cursor: pointer; transition: all 0.2s; font-family: inherit; }
        .lb-tab.active { background: var(--accent-red); color: white; }
        .lb-tab:hover:not(.active) { background: rgba(255,255,255,0.2); }
        .leaderboard-list { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.2); max-height: 350px; overflow-y: auto; }
        .leaderboard-item { display: flex; align-items: center; padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.1); transition: background 0.3s; }
        .leaderboard-item:last-child { border-bottom: none; }
        .leaderboard-item.gold { background: linear-gradient(90deg, rgba(255,215,0,0.2), transparent); }
        .leaderboard-item.highlight { animation: highlightNew 2s ease-out; }
        @keyframes highlightNew { 0% { background: rgba(0,255,0,0.3); } 100% { background: transparent; } }
        .leaderboard-item.me { background: rgba(233,69,96,0.2); border-right: 3px solid var(--accent-red); }
        .rank { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem; margin-left: 12px; background: rgba(255,255,255,0.2); color: #fff; }
        .rank.first { background: linear-gradient(135deg, #ffd700, #ffb300); color: #8B4513; }
        .rank.second { background: linear-gradient(135deg, #e0e0e0, #c0c0c0); color: #555; }
        .rank.third { background: linear-gradient(135deg, #cd7f32, #b87333); color: #fff; }
        .player-info { flex: 1; }
        .player-name { font-weight: 600; color: #fff; font-size: 0.9rem; }
        .player-province { font-size: 0.75rem; color: rgba(255,255,255,0.6); }
        .player-score { font-family: 'Orbitron', sans-serif; font-weight: 700; color: var(--accent-yellow); font-size: 1rem; }
        .leaderboard-live-indicator { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 8px; font-size: 0.75rem; color: rgba(255,255,255,0.6); }
        .live-dot { width: 8px; height: 8px; background: #00d9a5; border-radius: 50%; animation: pulse 2s infinite; }
        
        /* Achievements */
        .achievements-section { width: 100%; max-width: 400px; margin-top: 25px; }
        .achievements-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .achievement-badge { background: rgba(255,255,255,0.1); backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 12px 8px; text-align: center; opacity: 0.4; box-shadow: 0 3px 10px rgba(0,0,0,0.2); }
        .achievement-badge.unlocked { opacity: 1; box-shadow: 0 5px 20px rgba(255,215,0,0.3); background: linear-gradient(135deg, rgba(255,215,0,0.3), rgba(255,255,255,0.1)); border-color: rgba(255,215,0,0.3); }
        .achievement-badge .icon { font-size: 1.8rem; }
        .achievement-badge .name { font-size: 0.6rem; color: rgba(255,255,255,0.7); margin-top: 5px; }
        
        /* Footer */
        .home-footer { width: 100%; max-width: 400px; text-align: center; padding: 20px; margin-top: 30px; color: rgba(255,255,255,0.5); font-size: 0.8rem; }
        .home-footer span { color: var(--accent-yellow); font-weight: 600; }
        
        /* Game Screen */
        .game-wrapper { 
            height: 100%; 
            display: flex; 
            flex-direction: column; 
            max-width: 500px; 
            margin: 0 auto; 
            padding: 8px;
            box-sizing: border-box;
        }
        .game-header { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; height: 50px; }
        .logo-section { display: flex; align-items: center; gap: 8px; }
        .logo-section img { height: 35px; }
        .logo-text { font-family: 'Orbitron', sans-serif; font-size: 0.9rem; color: var(--bg-dark); font-weight: 700; }
        .close-btn { width: 36px; height: 36px; border-radius: 50%; background: var(--accent-red); border: none; color: white; font-size: 1.2rem; cursor: pointer; }
        .stats-bar { display: flex; justify-content: space-between; gap: 8px; margin: 8px 0; height: 55px; }
        .stat-box { flex: 1; background: var(--glass); border-radius: 12px; padding: 8px; text-align: center; }
        .stat-box.highlight { background: linear-gradient(135deg, var(--accent-red), #ff5252); color: white; }
        .stat-label { font-size: 0.6rem; color: #666; text-transform: uppercase; font-weight: 700; }
        .stat-box.highlight .stat-label { color: rgba(255,255,255,0.85); }
        .stat-value { font-family: 'Orbitron', sans-serif; font-size: 1rem; font-weight: 900; color: var(--bg-dark); }
        .stat-box.highlight .stat-value { color: white; }
        .main-area { flex: 1; display: flex; gap: 8px; min-height: 0; }
        
        /* Energy Bar */
        .energy-bar-container { width: 40px; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .energy-label { writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg); font-size: 0.55rem; font-weight: 700; color: var(--bg-dark); text-transform: uppercase; letter-spacing: 2px; }
        .energy-bar { flex: 1; width: 28px; background: var(--glass); border-radius: 14px; border: 3px solid var(--bg-dark); overflow: hidden; display: flex; flex-direction: column-reverse; }
        .energy-fill { width: 100%; background: linear-gradient(180deg, var(--accent-yellow) 0%, var(--accent-red) 100%); transition: height 0.5s ease; border-radius: 0 0 10px 10px; }
        .energy-icon { font-size: 1.1rem; margin-top: 5px; }
        
        /* Game Board */
        .game-board-wrapper { flex: 1; display: flex; flex-direction: column; background: var(--glass); border-radius: 15px; border: 4px solid var(--bg-dark); overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.15); }
        .board-header { padding: 6px 10px; background: linear-gradient(90deg, var(--bg-dark), #303f9f); display: flex; justify-content: center; }
        .board-header img { height: 22px; }
        .game-canvas-container { 
            flex: 1; 
            position: relative; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: linear-gradient(135deg, rgba(200,220,240,0.6), rgba(180,200,230,0.6));
        }
        .game-canvas-container::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60%;
            height: 85%;
            background: url('/uploads/can-bg.png') no-repeat center center;
            background-size: contain;
            opacity: 0.08;
            pointer-events: none;
            z-index: 0;
        }
        #game-canvas { background: rgba(180,200,230,0.4); border-radius: 5px; position: relative; z-index: 1; }
        .game-overlay { position: absolute; inset: 0; background: rgba(26,35,126,0.92); display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.3s; z-index: 10; }
        .game-overlay.hidden { opacity: 0; pointer-events: none; }
        .overlay-title { font-family: 'Orbitron', sans-serif; font-size: 2.5rem; color: white; }
        .overlay-subtitle { color: var(--accent-yellow); margin: 10px 0 25px; }
        .overlay-btn { padding: 14px 50px; background: linear-gradient(135deg, var(--accent-red), #ff5252); border: none; border-radius: 25px; color: white; font-family: 'Cairo', sans-serif; font-size: 1.1rem; font-weight: 700; cursor: pointer; }
        
        /* Combo Popup - shows then fades out */
        .combo-popup { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); font-family: 'Orbitron', sans-serif; font-weight: 900; color: white; background: linear-gradient(135deg, var(--accent-red), var(--accent-yellow)); padding: 15px 25px; border-radius: 20px; pointer-events: none; z-index: 100; opacity: 0; box-shadow: 0 10px 30px rgba(0,0,0,0.3); text-align: center; }
        .combo-popup .combo-text { font-size: 1.8rem; }
        .combo-popup .combo-msg { font-size: 1rem; font-family: 'Cairo', sans-serif; margin-top: 5px; opacity: 0.95; }
        .combo-popup.show { animation: comboShow 1.5s ease-out forwards; }
        @keyframes comboShow { 
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; } 
            20% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; } 
            40% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; } 
        }
        
        .bubbles-container { position: absolute; inset: 0; pointer-events: none; overflow: hidden; }
        .bubble { position: absolute; bottom: -20px; background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.9), rgba(200,230,255,0.5)); border-radius: 50%; animation: bubbleRise 2s ease-out forwards; }
        @keyframes bubbleRise { 0% { transform: translateY(0) scale(1); opacity: 0.9; } 100% { transform: translateY(-400px) scale(0.3); opacity: 0; } }
        
        /* Side Panel */
        .side-panel { width: 65px; display: flex; flex-direction: column; gap: 8px; }
        .panel-box { background: var(--glass); border-radius: 12px; padding: 10px 6px; text-align: center; }
        .panel-label { font-size: 0.5rem; color: #666; text-transform: uppercase; font-weight: 700; margin-bottom: 5px; }
        .hold-hint { font-size: 0.5rem; color: #999; margin-top: 3px; }
        .next-piece-canvas { width: 45px; height: 45px; margin: 0 auto; background: rgba(26,35,126,0.1); border-radius: 8px; }
        .multiplier-value { font-family: 'Orbitron', sans-serif; font-size: 1.3rem; font-weight: 900; color: var(--accent-red); }
        .special-item-img { width: 35px; height: auto; opacity: 0.3; transition: all 0.3s; }
        .special-item-img.active { opacity: 1; filter: drop-shadow(0 0 10px var(--accent-yellow)); animation: powerPulse 1s ease-in-out infinite; }
        @keyframes powerPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.15); } }
        
        /* Bottom Controls */
        .bottom-controls { display: flex; justify-content: center; align-items: center; padding: 8px 0; gap: 6px; height: 60px; }
        .control-btn { width: 40px; height: 40px; border-radius: 50%; background: var(--glass); border: 2px solid var(--bg-dark); display: flex; align-items: center; justify-content: center; font-size: 1rem; cursor: pointer; flex-shrink: 0; }
        .timer-display { width: 70px; text-align: center; font-family: 'Orbitron', sans-serif; font-size: 1.3rem; font-weight: 900; color: var(--bg-dark); flex-shrink: 0; }
        .timer-display.warning { color: var(--accent-red); animation: timerPulse 0.5s infinite; }
        @keyframes timerPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .score-display { background: var(--glass); border-radius: 10px; padding: 5px 8px; text-align: center; border: 2px solid var(--bg-dark); flex-shrink: 0; }
        .score-label { font-size: 0.45rem; color: #666; text-transform: uppercase; font-weight: 700; }
        .score-value { font-family: 'Orbitron', sans-serif; font-size: 0.9rem; font-weight: 900; color: var(--bg-dark); }
        .score-value { font-family: 'Orbitron', sans-serif; font-size: 1rem; font-weight: 900; color: var(--bg-dark); }
        .control-btn.off { opacity: 0.5; }
        
        /* Special Piece Effect */
        .special-effect {
            position: absolute;
            font-size: 2rem;
            pointer-events: none;
            z-index: 200;
            animation: specialBurst 1s ease-out forwards;
        }
        @keyframes specialBurst {
            0% { transform: scale(0.5); opacity: 1; }
            50% { transform: scale(1.5); opacity: 1; }
            100% { transform: scale(2) translateY(-50px); opacity: 0; }
        }
        
        /* Power-up Menu */
        .powerup-menu { position: fixed; inset: 0; z-index: 2000; display: flex; align-items: center; justify-content: center; }
        .powerup-menu.hidden { display: none; }
        .powerup-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.7); }
        .powerup-modal { position: relative; background: var(--glass); border-radius: 20px; padding: 20px; width: 90%; max-width: 350px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .powerup-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid rgba(0,0,0,0.1); }
        .powerup-header h3 { margin: 0; font-size: 1.1rem; color: var(--bg-dark); }
        .energy-display { background: linear-gradient(135deg, var(--accent-yellow), var(--accent-red)); padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 700; color: white; }
        .powerup-list { display: flex; flex-direction: column; gap: 10px; }
        .powerup-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(26,35,126,0.05); border-radius: 12px; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
        .powerup-item:hover { background: rgba(26,35,126,0.1); border-color: var(--accent-red); }
        .powerup-item.disabled { opacity: 0.5; pointer-events: none; }
        .powerup-icon { font-size: 2rem; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background: white; border-radius: 12px; box-shadow: 0 3px 10px rgba(0,0,0,0.1); }
        .powerup-info { flex: 1; }
        .powerup-name { font-weight: 700; color: var(--bg-dark); font-size: 0.95rem; }
        .powerup-desc { font-size: 0.75rem; color: #888; }
        .powerup-cost { font-weight: 700; color: var(--accent-red); font-size: 0.9rem; }
        .powerup-close { width: 100%; padding: 12px; margin-top: 15px; background: #eee; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; font-family: inherit; font-size: 0.95rem; }
        
        /* Theme Selector */
        .theme-selector { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: var(--glass); border-radius: 15px; padding: 15px; display: flex; gap: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 1500; }
        .theme-selector.hidden { display: none; }
        .theme-option { cursor: pointer; text-align: center; padding: 8px; border-radius: 10px; border: 2px solid transparent; transition: all 0.2s; }
        .theme-option:hover { background: rgba(0,0,0,0.05); }
        .theme-option.active { border-color: var(--accent-red); background: rgba(233,69,96,0.1); }
        .theme-preview { width: 50px; height: 50px; border-radius: 8px; display: grid; grid-template-columns: 1fr 1fr; gap: 2px; padding: 5px; margin-bottom: 5px; }
        .theme-preview span { border-radius: 3px; }
        .theme-name { font-size: 0.7rem; font-weight: 600; color: var(--bg-dark); }
        
        /* Game Over Screen */
        .gameover-screen { align-items: center; justify-content: center; padding: 20px; }
        .gameover-card { background: var(--glass); border-radius: 25px; padding: 30px; width: 100%; max-width: 380px; box-shadow: 0 15px 50px rgba(0,0,0,0.15); text-align: center; }
        .gameover-icon { font-size: 4rem; margin-bottom: 10px; }
        .gameover-title { font-family: 'Orbitron', sans-serif; font-size: 1.4rem; color: var(--bg-dark); margin-bottom: 20px; }
        .score-breakdown { background: rgba(26,35,126,0.08); border-radius: 15px; padding: 15px; margin-bottom: 20px; }
        .score-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(0,0,0,0.08); }
        .score-row:last-child { border-bottom: none; font-weight: 700; font-size: 1.2rem; color: var(--accent-red); }
        .gameover-btn { width: 100%; padding: 14px; border: none; border-radius: 12px; font-family: inherit; font-size: 1rem; font-weight: 700; cursor: pointer; margin-top: 10px; }
        .gameover-btn.primary { background: linear-gradient(135deg, var(--accent-red), #ff5252); color: white; }
        .gameover-btn.secondary { background: var(--bg-dark); color: white; }
        .gameover-btn.whatsapp { background: #25d366; color: white; }
        .gameover-btn.check { background: linear-gradient(135deg, var(--accent-yellow), #ffb300); color: var(--bg-dark); }
        
        /* Achievement Popup & Toast */
        .achievement-popup { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-120px); background: linear-gradient(135deg, var(--accent-yellow), #ffb300); padding: 12px 25px; border-radius: 25px; display: flex; align-items: center; gap: 10px; box-shadow: 0 10px 35px rgba(0,0,0,0.25); z-index: 10000; transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .achievement-popup.show { transform: translateX(-50%) translateY(0); }
        .achievement-icon { font-size: 1.5rem; }
        .achievement-text { font-weight: 700; color: var(--bg-dark); }
        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(60px); background: var(--bg-dark); color: white; padding: 12px 30px; border-radius: 25px; opacity: 0; transition: all 0.3s; z-index: 10000; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        
        /* Notification Banner */
        .notification-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 15px 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            text-align: center;
            z-index: 9999;
            transform: translateY(-100%);
            transition: transform 0.4s ease;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        .notification-banner.show { transform: translateY(0); }
        .notification-banner.win { background: linear-gradient(135deg, #f093fb, #f5576c); }
        .notification-banner.reminder { background: linear-gradient(135deg, #4facfe, #00f2fe); }
        .notification-content { display: flex; align-items: center; justify-content: center; gap: 10px; flex-wrap: wrap; }
        .notification-icon { font-size: 1.5rem; }
        .notification-text { font-weight: 600; }
        .notification-btn { padding: 8px 20px; background: rgba(255,255,255,0.2); border: 2px solid white; border-radius: 20px; color: white; font-weight: 700; cursor: pointer; transition: all 0.3s; margin-right: 10px; }
        .notification-btn:hover { background: white; color: #667eea; }
        .notification-close { position: absolute; top: 50%; right: 15px; transform: translateY(-50%); background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; opacity: 0.7; }
        .notification-close:hover { opacity: 1; }
    </style>
    <link rel="stylesheet" href="/css/themes.css">
    <script src="/js/themes.js"></script>
    <script src="/js/sounds.js"></script>
</head>
<body class="dark-mode">
    <!-- Notification Banner -->
    <div class="notification-banner" id="notification-banner">
        <div class="notification-content">
            <span class="notification-icon" id="notification-icon"></span>
            <span class="notification-text" id="notification-text"></span>
            <button class="notification-btn" id="notification-btn" onclick="Game.handleNotificationAction()"></button>
        </div>
        <button class="notification-close" onclick="Game.hideNotification()"></button>
    </div>
    
    <!-- Animated Background -->
    <div class="game-background">
        <div class="bg-stars"></div>
        <div class="bg-glow red"></div>
        <div class="bg-glow yellow"></div>
        <div class="bg-glow blue"></div>
        <div class="bg-wave"></div>
    </div>
    
    <!-- Particle Canvas -->
    <canvas id="particle-canvas"></canvas>
    
    <!-- Loading Screen -->
    <div class="loading-screen" id="loading-screen">
        <div class="loading-particles">
            <div class="particle" style="left:10%;top:20%;width:8px;height:8px;animation-delay:0s;"></div>
            <div class="particle" style="left:80%;top:30%;width:6px;height:6px;animation-delay:0.5s;"></div>
            <div class="particle" style="left:20%;top:70%;width:10px;height:10px;animation-delay:1s;"></div>
            <div class="particle" style="left:70%;top:80%;width:7px;height:7px;animation-delay:1.5s;"></div>
            <div class="particle" style="left:50%;top:15%;width:5px;height:5px;animation-delay:2s;"></div>
        </div>
        <div class="loading-can-container">
            <div class="can-glow"></div>
            <div class="energy-ring"></div>
            <div class="energy-ring"></div>
            <div class="energy-ring"></div>
            <img src="/uploads/redstrong.png" alt="Red Strong" class="loading-can" id="loading-logo">
        </div>
        <h1 class="loading-title"><span class="red" id="loading-name-1">RED</span> <span class="strong" id="loading-name-2">STRONG</span></h1>
        <p class="loading-subtitle" id="loading-subtitle"> TETRIS</p>
        <div class="loading-bar-bg"><div class="loading-bar-fill"></div></div>
        <p class="loading-text"> ...</p>
        <div class="tetris-blocks">
            <div class="tetris-block"></div><div class="tetris-block"></div><div class="tetris-block"></div>
            <div class="tetris-block"></div><div class="tetris-block"></div><div class="tetris-block"></div>
        </div>
    </div>

    <div class="achievement-popup" id="achievement-popup"><span class="achievement-icon"></span><span class="achievement-text" id="achievement-text"> !</span></div>
    <div class="toast" id="toast"></div>

    <!-- Home Screen -->
    <div class="screen home-screen active" id="home-screen">
        <div class="home-header">
            <img src="/uploads/redstrong.png" alt="Logo" class="home-logo-small" id="header-logo">
            <div class="header-buttons">
                <button class="mode-toggle-btn" onclick="Game.openThemes()" title=""></button>
                <button class="check-win-btn" onclick="Game.checkWin()">   </button>
            </div>
        </div>
        <div class="home-hero">
            <img src="/uploads/redstrong.png" alt="Red Strong" class="home-logo" id="hero-logo">
            <h1 class="brand-title" id="site-name">
                <span class="brand-red">Red</span> <span class="brand-strong">Strong</span>
            </h1>
            <p class="home-subtitle" id="site-subtitle">   !</p>
        </div>
        <div class="stats-cards">
            <div class="stat-card"><div class="stat-card-icon"></div><div class="stat-card-value" id="games-played-stat">0</div><div class="stat-card-label"></div></div>
            <div class="stat-card"><div class="stat-card-icon"></div><div class="stat-card-value" id="best-score-stat">0</div><div class="stat-card-label"> </div></div>
            <div class="stat-card"><div class="stat-card-icon"></div><div class="stat-card-value" id="achievements-stat">0/8</div><div class="stat-card-label"></div></div>
        </div>
        
        <!-- Current Prize Section -->
        <div class="prize-section" id="prize-section" style="display:none;">
            <div class="prize-card">
                <div class="prize-badge">   </div>
                <div class="prize-image-wrapper">
                    <img src="" alt="Prize" class="prize-image" id="current-prize-image">
                </div>
                <h3 class="prize-name" id="current-prize-name">-</h3>
                <p class="prize-desc" id="current-prize-desc">    !</p>
            </div>
        </div>
        
        <!-- Announcements Section -->
        <div class="announcements-section" id="announcements-section" style="display:none;">
            <div class="announcements-slider" id="announcements-slider"></div>
        </div>
        
        <div class="home-card">
            <form id="register-form">
                <div class="form-group"><label></label><input type="text" class="form-input" id="player-name" placeholder=" " required></div>
                <div class="form-group"><label></label><select class="form-input" id="player-province" required><option value=""> </option></select></div>
                <div class="form-group"><label> </label><input type="tel" class="form-input" id="player-phone" placeholder="07XX XXX XXXX" required></div>
                <button type="submit" class="play-btn">  </button>
            </form>
        </div>
        <div class="leaderboard-section">
            <div class="leaderboard-header">
                <h3 class="section-title">  </h3>
                <div class="leaderboard-tabs">
                    <button class="lb-tab active" data-period="today" onclick="Game.loadLeaderboard('today')"></button>
                    <button class="lb-tab" data-period="week" onclick="Game.loadLeaderboard('week')"></button>
                    <button class="lb-tab" data-period="all" onclick="Game.loadLeaderboard('all')"></button>
                </div>
            </div>
            <div class="leaderboard-list" id="leaderboard-list"><div class="leaderboard-item"><div class="rank">-</div><div class="player-info"><div class="player-name" style="color:#888;"> ...</div></div></div></div>
            <div class="leaderboard-live-indicator">
                <span class="live-dot"></span>
                <span> </span>
            </div>
        </div>
        <div class="achievements-section">
            <h3 class="section-title"> </h3>
            <div class="achievements-grid" id="achievements-grid">
                <div class="achievement-badge" data-id="first_game"><div class="icon"></div><div class="name"> </div></div>
                <div class="achievement-badge" data-id="score_1000"><div class="icon"></div><div class="name">1000 </div></div>
                <div class="achievement-badge" data-id="score_5000"><div class="icon"></div><div class="name">5000 </div></div>
                <div class="achievement-badge" data-id="combo_3"><div class="icon"></div><div class="name"> x3</div></div>
                <div class="achievement-badge" data-id="lines_10"><div class="icon"></div><div class="name">10 </div></div>
                <div class="achievement-badge" data-id="power_up"><div class="icon"></div><div class="name"> </div></div>
                <div class="achievement-badge" data-id="games_5"><div class="icon"></div><div class="name">5 </div></div>
                <div class="achievement-badge" data-id="games_10"><div class="icon"></div><div class="name">10 </div></div>
            </div>
        </div>
        
        <!-- Contact Section -->
        <div class="contact-section">
            <div class="contact-card">
                <h3 class="contact-title">  </h3>
                <a href="tel:07748008688" class="contact-item">
                    <span class="text">07748008688</span>
                    <span class="icon"></span>
                </a>
                <a href="/cdn-cgi/l/email-protection#066b696e676b63624673736264702865696b" class="contact-item">
                    <span class="text"><span class="__cf_email__" data-cfemail="aec3c1c6cfc3cbcaeedbdbcaccd880cdc1c3">[email&#160;protected]</span></span>
                    <span class="icon"></span>
                </a>
            </div>
            <div class="social-card">
                <h3 class="social-title"> </h3>
                <div class="social-icons">
                    <a href="https://wa.me/96407748008688" target="_blank" class="social-btn whatsapp">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                    </a>
                    <a href="https://instagram.com/redstrong" target="_blank" class="social-btn instagram">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
                    </a>
                    <a href="https://facebook.com/redstrong" target="_blank" class="social-btn facebook">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="home-footer">
            <p> 2025 <span id="footer-company">Red Strong</span>.   </p>
        </div>
    </div>

    <!-- Game Screen -->
    <div class="screen" id="game-screen">
        <div class="game-wrapper">
            <div class="game-header">
                <div class="logo-section"><img src="/uploads/redstrong.png" alt="Logo"><span class="logo-text">TETRIS</span></div>
                <button class="close-btn" onclick="Game.exit()"></button>
            </div>
            <div class="stats-bar">
                <div class="stat-box"><div class="stat-label"></div><div class="stat-value" id="round-display">1/3</div></div>
                <div class="stat-box highlight"><div class="stat-label"></div><div class="stat-value" id="level-display">1</div></div>
                <div class="stat-box"><div class="stat-label"></div><div class="stat-value" id="lines-display">0</div></div>
            </div>
            <div class="main-area">
                <div class="energy-bar-container">
                    <span class="energy-label">ENERGY</span>
                    <div class="energy-bar"><div class="energy-fill" id="energy-fill" style="height:0%;"></div></div>
                    <span class="energy-icon"></span>
                </div>
                <div class="game-board-wrapper">
                    <div class="board-header"><img src="/uploads/redstrong.png" alt="Red Strong"></div>
                    <div class="game-canvas-container" id="game-container">
                        <canvas id="game-canvas"></canvas>
                        <div class="bubbles-container" id="bubbles-container"></div>
                        <div class="combo-popup" id="combo-popup"></div>
                        <div class="game-overlay" id="game-overlay">
                            <div class="overlay-title" id="overlay-title">GO!</div>
                            <p class="overlay-subtitle" id="overlay-subtitle"> </p>
                            <button class="overlay-btn" id="overlay-btn" onclick="Game.start()"></button>
                        </div>
                    </div>
                </div>
                <div class="side-panel">
                    <div class="panel-box"><div class="panel-label"></div><canvas class="next-piece-canvas" id="hold-canvas" width="45" height="45"></canvas><div class="hold-hint"> H</div></div>
                    <div class="panel-box"><div class="panel-label"></div><canvas class="next-piece-canvas" id="next-canvas" width="45" height="45"></canvas></div>
                    <div class="panel-box"><div class="panel-label"></div><div class="multiplier-value" id="multiplier-display">1x</div></div>
                    <div class="panel-box"><div class="panel-label"></div><img src="/uploads/redstrong.png" alt="Power" class="special-item-img" id="power-icon"></div>
                </div>
            </div>
            <div class="bottom-controls">
                <button class="control-btn" onclick="Game.pause()"></button>
                <button class="control-btn" onclick="Game.usePowerUp()"></button>
                <button class="control-btn" id="sound-btn" onclick="Game.toggleSound()"></button>
                <button class="control-btn" id="ghost-btn" onclick="Game.toggleGhost()"></button>
                <button class="control-btn" onclick="Game.showThemeSelector()"></button>
                <div class="timer-display" id="timer-display">3:00</div>
                <div class="score-display"><div class="score-label"></div><div class="score-value" id="score-display">0</div></div>
            </div>
        </div>
    </div>

    <!-- Power-up Menu -->
    <div class="powerup-menu hidden" id="powerup-menu">
        <div class="powerup-overlay" onclick="Game.hidePowerUpMenu()"></div>
        <div class="powerup-modal">
            <div class="powerup-header">
                <h3>   </h3>
                <div class="energy-display">: <span id="menu-energy">0</span> </div>
            </div>
            <div class="powerup-list" id="powerup-list"></div>
            <button class="powerup-close" onclick="Game.hidePowerUpMenu()"></button>
        </div>
    </div>

    <!-- Theme Selector -->
    <div class="theme-selector hidden" id="theme-selector"></div>

    <!-- Game Over Screen -->
    <div class="screen gameover-screen" id="gameover-screen">
        <div class="gameover-card">
            <div class="gameover-icon" id="gameover-icon"></div>
            <h2 class="gameover-title" id="gameover-title"> !</h2>
            <div class="score-breakdown">
                <div class="score-row"><span> </span><span id="round-score">0</span></div>
                <div class="score-row"><span> </span><span id="combo-bonus">0</span></div>
                <div class="score-row"><span> </span><span id="final-score">0</span></div>
            </div>
            <div id="next-round-info"><p style="color:#666;margin-bottom:15px;font-size:0.9rem;">    <strong id="next-difficulty" style="color:var(--accent-red);">20%</strong></p></div>
            <button class="gameover-btn check" onclick="Game.checkWin()">   </button>
            <button class="gameover-btn whatsapp" onclick="Game.share()">   </button>
            <button class="gameover-btn primary" id="next-round-btn" onclick="Game.nextRound()">  </button>
            <button class="gameover-btn secondary" onclick="Game.goHome()"> </button>
        </div>
    </div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script src="/js/config.js"></script>
    <script src="/js/utils.js"></script>
    <script src="/js/api.js"></script>
    <script>
        // ========== PARTICLE SYSTEM ==========
        const ParticleSystem = {
            canvas: null,
            ctx: null,
            particles: [],
            
            init() {
                this.canvas = document.getElementById('particle-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.resize();
                window.addEventListener('resize', () => this.resize());
                this.animate();
            },
            
            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
            },
            
            // Create explosion particles
            createExplosion(x, y, color, count = 20) {
                for (let i = 0; i < count; i++) {
                    const angle = (Math.PI * 2 * i) / count;
                    const speed = 3 + Math.random() * 5;
                    this.particles.push({
                        x: x,
                        y: y,
                        vx: Math.cos(angle) * speed,
                        vy: Math.sin(angle) * speed,
                        size: 3 + Math.random() * 4,
                        color: color,
                        alpha: 1,
                        decay: 0.02 + Math.random() * 0.02,
                        type: 'explosion'
                    });
                }
            },
            
            // Create sparkle particles
            createSparkles(x, y, count = 15) {
                const colors = ['#ffd700', '#ff6b6b', '#4ecdc4', '#fff', '#ff9ff3'];
                for (let i = 0; i < count; i++) {
                    this.particles.push({
                        x: x + (Math.random() - 0.5) * 50,
                        y: y + (Math.random() - 0.5) * 50,
                        vx: (Math.random() - 0.5) * 3,
                        vy: -2 - Math.random() * 3,
                        size: 2 + Math.random() * 3,
                        color: colors[Math.floor(Math.random() * colors.length)],
                        alpha: 1,
                        decay: 0.015 + Math.random() * 0.01,
                        type: 'sparkle',
                        rotation: Math.random() * Math.PI * 2
                    });
                }
            },
            
            // Create line clear effect
            createLineClear(y, width, blockSize) {
                const colors = ['#e31e24', '#ffd700', '#00bcd4', '#4caf50', '#ff9800'];
                for (let x = 0; x < width; x += 10) {
                    for (let i = 0; i < 3; i++) {
                        this.particles.push({
                            x: x,
                            y: y,
                            vx: (Math.random() - 0.5) * 8,
                            vy: -3 - Math.random() * 5,
                            size: 4 + Math.random() * 4,
                            color: colors[Math.floor(Math.random() * colors.length)],
                            alpha: 1,
                            decay: 0.02,
                            type: 'square',
                            rotation: Math.random() * Math.PI * 2,
                            rotationSpeed: (Math.random() - 0.5) * 0.3
                        });
                    }
                }
            },
            
            // Create special piece glow
            createSpecialGlow(x, y) {
                for (let i = 0; i < 30; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const dist = Math.random() * 30;
                    this.particles.push({
                        x: x + Math.cos(angle) * dist,
                        y: y + Math.sin(angle) * dist,
                        vx: Math.cos(angle) * 2,
                        vy: Math.sin(angle) * 2,
                        size: 3 + Math.random() * 5,
                        color: Math.random() > 0.5 ? '#ffd700' : '#e31e24',
                        alpha: 1,
                        decay: 0.03,
                        type: 'glow'
                    });
                }
            },
            
            // Create trail effect
            createTrail(x, y, color) {
                this.particles.push({
                    x: x,
                    y: y,
                    vx: 0,
                    vy: 0,
                    size: 8,
                    color: color,
                    alpha: 0.6,
                    decay: 0.05,
                    type: 'trail'
                });
            },
            
            animate() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                for (let i = this.particles.length - 1; i >= 0; i--) {
                    const p = this.particles[i];
                    
                    // Update
                    p.x += p.vx;
                    p.y += p.vy;
                    p.vy += 0.1; // Gravity
                    p.alpha -= p.decay;
                    
                    if (p.rotation !== undefined) {
                        p.rotation += p.rotationSpeed || 0;
                    }
                    
                    // Remove dead particles
                    if (p.alpha <= 0) {
                        this.particles.splice(i, 1);
                        continue;
                    }
                    
                    // Draw
                    this.ctx.save();
                    this.ctx.globalAlpha = p.alpha;
                    this.ctx.fillStyle = p.color;
                    
                    if (p.type === 'square') {
                        this.ctx.translate(p.x, p.y);
                        this.ctx.rotate(p.rotation);
                        this.ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
                    } else if (p.type === 'sparkle') {
                        this.ctx.translate(p.x, p.y);
                        this.ctx.rotate(p.rotation);
                        // Draw star shape
                        this.ctx.beginPath();
                        for (let j = 0; j < 4; j++) {
                            const angle = (j * Math.PI) / 2;
                            this.ctx.lineTo(Math.cos(angle) * p.size, Math.sin(angle) * p.size);
                            this.ctx.lineTo(Math.cos(angle + Math.PI/4) * p.size * 0.4, Math.sin(angle + Math.PI/4) * p.size * 0.4);
                        }
                        this.ctx.closePath();
                        this.ctx.fill();
                    } else if (p.type === 'glow') {
                        this.ctx.shadowBlur = 15;
                        this.ctx.shadowColor = p.color;
                        this.ctx.beginPath();
                        this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                        this.ctx.fill();
                    } else {
                        // Circle (explosion, trail)
                        this.ctx.beginPath();
                        this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                        this.ctx.fill();
                    }
                    
                    this.ctx.restore();
                }
                
                requestAnimationFrame(() => this.animate());
            }
        };
        
        // Initialize particle system
        document.addEventListener('DOMContentLoaded', () => ParticleSystem.init());
        
        // ========== GAME ==========
        const Game = {
            canvas: null, ctx: null, nextCanvas: null, nextCtx: null, holdCanvas: null, holdCtx: null,
            board: [], currentPiece: null, nextPiece: null, holdPiece: null, canHold: true,
            score: 0, level: 1, lines: 0, combo: 0, multiplier: 1, energy: 0, powerUpReady: false,
            gameActive: false, isPaused: false, timeRemaining: 180, timerInterval: null, dropInterval: 1000, lastDrop: 0, animationId: null,
            player: null, currentRound: 1, maxRounds: 3, totalScore: 0, sessionId: null, difficultyLevel: 0,
            achievements: {}, gamesPlayed: 0, bestScore: 0,
            siteSettings: {},
            COLS: 10, ROWS: 20, BLOCK_SIZE: 0,
            COLORS: ['', '#e31e24', '#00bcd4', '#ffd700', '#ff9800', '#4caf50', '#9c27b0', '#1a237e'],
            SHAPES: [[], [[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]], [[2,0,0],[2,2,2],[0,0,0]], [[0,0,3],[3,3,3],[0,0,0]], [[4,4],[4,4]], [[0,5,5],[5,5,0],[0,0,0]], [[0,6,0],[6,6,6],[0,0,0]], [[7,7,0],[0,7,7],[0,0,0]]],
            
            // Sound & Ghost settings
            soundEnabled: true,
            ghostEnabled: true,
            audioCtx: null,
            comboTimeout: null,
            lastClearTime: 0,
            
            // Power-ups System
            powerUps: {
                bomb: { name: '', icon: '', description: ' 3 ', cost: 100, active: false },
                freeze: { name: '', icon: '', description: ' 10 ', cost: 80, active: false },
                shuffle: { name: '', icon: '', description: '  ', cost: 60, active: false },
                ghost: { name: '', icon: '', description: '   ', cost: 120, active: false }
            },
            activePowerUp: null,
            powerUpTimer: null,
            slowMotion: false,
            wallPass: false,
            
            // Themes System
            themes: {
                classic: { name: '', colors: ['', '#e31e24', '#00bcd4', '#ffd700', '#ff9800', '#4caf50', '#9c27b0', '#1a237e'], bg: 'rgba(180,200,230,0.4)', grid: 'rgba(26,35,126,0.1)' },
                neon: { name: '', colors: ['', '#ff0080', '#00ffff', '#ffff00', '#ff00ff', '#00ff00', '#ff8000', '#0080ff'], bg: 'rgba(10,10,30,0.9)', grid: 'rgba(0,255,255,0.1)' },
                retro: { name: '', colors: ['', '#ff6b6b', '#4ecdc4', '#ffe66d', '#95e1d3', '#f38181', '#aa96da', '#fcbad3'], bg: 'rgba(45,52,54,0.9)', grid: 'rgba(255,255,255,0.05)' },
                candy: { name: '', colors: ['', '#ff6b9d', '#c44dff', '#ffde59', '#ff914d', '#5ce1e6', '#cb6ce6', '#38b6ff'], bg: 'rgba(255,230,240,0.9)', grid: 'rgba(200,100,150,0.1)' },
                dark: { name: '', colors: ['', '#dc3545', '#0dcaf0', '#ffc107', '#fd7e14', '#198754', '#6f42c1', '#0d6efd'], bg: 'rgba(15,15,25,0.95)', grid: 'rgba(255,255,255,0.03)' }
            },
            currentTheme: 'classic',
            
            init() {
                this.canvas = document.getElementById('game-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.nextCanvas = document.getElementById('next-canvas');
                this.nextCtx = this.nextCanvas.getContext('2d');
                this.holdCanvas = document.getElementById('hold-canvas');
                this.holdCtx = this.holdCanvas?.getContext('2d');
                this.initSound();
                this.loadSoundSettings();
                this.loadTheme();
                this.loadModePreference();
                this.loadSiteSettings();
                this.loadPlayer(); this.loadAchievements(); this.loadStats(); this.setupProvinces(); this.setupForm(); this.setupTouch(); this.setupKeyboard(); this.loadLeaderboard(); this.startLeaderboardUpdates();
                // Load prizes and announcements
                this.loadCurrentPrize();
                this.loadAnnouncements();
                // Check for notifications
                this.checkDailyReminder();
                this.checkWinNotification();
                setTimeout(() => document.getElementById('loading-screen').classList.add('hidden'), 2500);
            },
            
            initSound() {
                // AudioContext needs user interaction first
                this.audioCtx = null;
            },
            
            ensureAudioContext() {
                if (!this.audioCtx) {
                    try {
                        const AudioContext = window.AudioContext || window.webkitAudioContext;
                        this.audioCtx = new AudioContext();
                    } catch (e) {
                        console.log('Audio not supported');
                        return false;
                    }
                }
                // Resume if suspended
                if (this.audioCtx.state === 'suspended') {
                    this.audioCtx.resume();
                }
                return true;
            },
            
            loadSoundSettings() {
                this.soundEnabled = localStorage.getItem('gameSoundEnabled') !== 'false';
                this.ghostEnabled = localStorage.getItem('gameGhostEnabled') !== 'false';
                this.updateSoundButton();
                this.updateGhostButton();
            },
            
            playSound(type) {
                if (!this.soundEnabled) return;
                if (!this.ensureAudioContext()) return;
                
                try {
                    const osc = this.audioCtx.createOscillator();
                    const gain = this.audioCtx.createGain();
                    osc.connect(gain);
                    gain.connect(this.audioCtx.destination);
                    
                    switch(type) {
                        case 'move':
                            osc.frequency.value = 200; gain.gain.value = 0.1;
                            osc.start(); osc.stop(this.audioCtx.currentTime + 0.05);
                            break;
                        case 'rotate':
                            osc.frequency.value = 300; gain.gain.value = 0.1;
                            osc.start(); osc.stop(this.audioCtx.currentTime + 0.08);
                            break;
                        case 'drop':
                            osc.frequency.value = 150; osc.type = 'square'; gain.gain.value = 0.15;
                            osc.start(); osc.stop(this.audioCtx.currentTime + 0.1);
                            break;
                        case 'clear':
                            osc.frequency.value = 500; gain.gain.value = 0.2;
                            osc.start();
                            osc.frequency.exponentialRampToValueAtTime(800, this.audioCtx.currentTime + 0.1);
                            osc.stop(this.audioCtx.currentTime + 0.15);
                            break;
                        case 'tetris':
                            osc.frequency.value = 600; gain.gain.value = 0.25;
                            osc.start();
                            osc.frequency.exponentialRampToValueAtTime(1200, this.audioCtx.currentTime + 0.2);
                            osc.stop(this.audioCtx.currentTime + 0.3);
                            break;
                        case 'combo':
                            osc.frequency.value = 400 + (this.combo * 100); osc.type = 'triangle'; gain.gain.value = 0.15;
                            osc.start();
                            osc.frequency.exponentialRampToValueAtTime(800 + (this.combo * 100), this.audioCtx.currentTime + 0.15);
                            osc.stop(this.audioCtx.currentTime + 0.2);
                            break;
                        case 'levelUp':
                            osc.frequency.value = 400; gain.gain.value = 0.2;
                            osc.start();
                            osc.frequency.exponentialRampToValueAtTime(800, this.audioCtx.currentTime + 0.1);
                            osc.stop(this.audioCtx.currentTime + 0.3);
                            break;
                        case 'gameOver':
                            osc.frequency.value = 400; osc.type = 'sawtooth'; gain.gain.value = 0.2;
                            osc.start();
                            osc.frequency.exponentialRampToValueAtTime(100, this.audioCtx.currentTime + 0.5);
                            osc.stop(this.audioCtx.currentTime + 0.5);
                            break;
                    }
                } catch (e) {}
            },
            
            toggleSound() {
                this.soundEnabled = !this.soundEnabled;
                localStorage.setItem('gameSoundEnabled', this.soundEnabled);
                this.updateSoundButton();
                if (this.soundEnabled) this.playSound('move');
            },
            
            updateSoundButton() {
                const btn = document.getElementById('sound-btn');
                if (btn) {
                    btn.textContent = this.soundEnabled ? '' : '';
                    btn.classList.toggle('off', !this.soundEnabled);
                }
            },
            
            toggleGhost() {
                this.ghostEnabled = !this.ghostEnabled;
                localStorage.setItem('gameGhostEnabled', this.ghostEnabled);
                this.updateGhostButton();
            },
            
            updateGhostButton() {
                const btn = document.getElementById('ghost-btn');
                if (btn) {
                    btn.classList.toggle('off', !this.ghostEnabled);
                }
            },
            
            // Light/Dark Mode Toggle
            isDarkMode: true,
            
            toggleMode() {
                this.isDarkMode = !this.isDarkMode;
                document.body.classList.toggle('dark-mode', this.isDarkMode);
                document.body.classList.toggle('light-mode', !this.isDarkMode);
                
                // Update button icon
                const btn = document.getElementById('mode-toggle');
                if (btn) {
                    btn.textContent = this.isDarkMode ? '' : '';
                }
                
                // Save preference
                localStorage.setItem('gameMode', this.isDarkMode ? 'dark' : 'light');
            },
            
            loadModePreference() {
                const saved = localStorage.getItem('gameMode');
                if (saved === 'light') {
                    this.isDarkMode = false;
                    document.body.classList.add('light-mode');
                    document.body.classList.remove('dark-mode');
                    const btn = document.getElementById('mode-toggle');
                    if (btn) btn.textContent = '';
                } else {
                    this.isDarkMode = true;
                    document.body.classList.add('dark-mode');
                    document.body.classList.remove('light-mode');
                }
            },
            
            async loadSiteSettings() {
                try {
                    const res = await fetch('/api/settings/public');
                    const settings = await res.json();
                    this.siteSettings = settings;
                    
                    // Update page title
                    if (settings.site_title) document.title = settings.site_title;
                    
                    // Update loading screen
                    if (settings.site_name) {
                        const nameParts = settings.site_name.split(' ');
                        if (nameParts.length >= 2) {
                            document.getElementById('loading-name-1').textContent = nameParts[0];
                            document.getElementById('loading-name-2').textContent = nameParts.slice(1).join(' ');
                        } else {
                            document.getElementById('loading-name-1').textContent = settings.site_name;
                            document.getElementById('loading-name-2').textContent = '';
                        }
                    }
                    
                    // Update home screen
                    if (settings.site_name) {
                        const siteNameEl = document.getElementById('site-name');
                        const nameParts = settings.site_name.split(' ');
                        if (nameParts.length >= 2) {
                            // Keep Red always red, Strong changes with mode
                            siteNameEl.innerHTML = '<span class="brand-red">' + nameParts[0] + '</span> <span class="brand-strong">' + nameParts.slice(1).join(' ') + '</span>';
                        } else {
                            siteNameEl.innerHTML = '<span class="brand-red">' + settings.site_name + '</span>';
                        }
                    }
                    if (settings.site_subtitle) document.getElementById('site-subtitle').textContent = settings.site_subtitle;
                    
                    // Update logos
                    if (settings.logo_image) {
                        document.getElementById('loading-logo').src = settings.logo_image;
                        document.getElementById('header-logo').src = settings.logo_image;
                        document.getElementById('hero-logo').src = settings.logo_image;
                    }
                    
                    // Update colors (CSS variables)
                    if (settings.primary_color) document.documentElement.style.setProperty('--accent-red', settings.primary_color);
                    if (settings.secondary_color) document.documentElement.style.setProperty('--bg-dark', settings.secondary_color);
                    if (settings.gold_color) document.documentElement.style.setProperty('--accent-yellow', settings.gold_color);
                    
                    // Update footer
                    if (settings.footer_company) document.getElementById('footer-company').textContent = settings.footer_company;
                    
                } catch (err) {
                    console.log('Could not load site settings, using defaults');
                }
            },
            
            async loadCurrentPrize() {
                try {
                    const res = await fetch('/api/prizes/active');
                    const prizes = await res.json();
                    
                    if (prizes && prizes.length > 0) {
                        const prize = prizes[0]; // Show first active prize
                        const section = document.getElementById('prize-section');
                        const image = document.getElementById('current-prize-image');
                        const name = document.getElementById('current-prize-name');
                        const desc = document.getElementById('current-prize-desc');
                        
                        if (prize.image) {
                            image.src = prize.image;
                            image.style.display = 'block';
                        } else {
                            image.style.display = 'none';
                        }
                        
                        name.textContent = prize.name;
                        desc.textContent = prize.description || '    !';
                        section.style.display = 'block';
                    }
                } catch (err) {
                    console.log('Could not load prizes');
                }
            },
            
            async loadAnnouncements() {
                try {
                    const res = await fetch('/api/announcements/active');
                    const announcements = await res.json();
                    
                    if (announcements && announcements.length > 0) {
                        const section = document.getElementById('announcements-section');
                        const slider = document.getElementById('announcements-slider');
                        
                        // Type badges
                        const typeBadges = {
                            urgent: { text: ' ', class: 'urgent' },
                            info: { text: ' ', class: 'info' },
                            promo: { text: ' ', class: 'promo' },
                            new: { text: ' ', class: 'new' }
                        };
                        
                        // Build slides
                        let slidesHTML = announcements.map((ann, index) => {
                            const badge = typeBadges[ann.type] || typeBadges.info;
                            const hasImage = ann.image && ann.image.length > 0;
                            const hasLink = ann.link && ann.link.length > 0;
                            
                            return `
                                <div class="announcement-slide ${index === 0 ? 'active' : ''}" data-index="${index}">
                                    <div class="announcement-card ${hasImage ? 'has-image' : 'no-image'}" 
                                         ${hasLink ? `onclick="window.open('${ann.link}', '_blank')"` : ''}>
                                        ${hasImage ? `<img src="${ann.image}" class="ann-image" alt="">` : ''}
                                        <div class="ann-content">
                                            <div class="ann-badge ${badge.class}">${badge.text}</div>
                                            <div class="ann-title">${ann.title || ''}</div>
                                            <div class="ann-text">${ann.text || ''}</div>
                                        </div>
                                        ${hasLink ? '<span class="ann-arrow"></span>' : ''}
                                    </div>
                                </div>
                            `;
                        }).join('');
                        
                        // Add dots if multiple announcements
                        if (announcements.length > 1) {
                            const dotsHTML = announcements.map((_, i) => 
                                `<span class="announcement-dot ${i === 0 ? 'active' : ''}" data-index="${i}" onclick="Game.goToAnnouncement(${i})"></span>`
                            ).join('');
                            slidesHTML += `<div class="announcement-dots">${dotsHTML}</div>`;
                        }
                        
                        slider.innerHTML = slidesHTML;
                        section.style.display = 'block';
                        
                        // Auto-slide if multiple
                        if (announcements.length > 1) {
                            this.startAnnouncementSlider(announcements.length);
                        }
                    }
                } catch (err) {
                    console.log('Could not load announcements');
                }
            },
            
            announcementSliderInterval: null,
            currentAnnouncementIndex: 0,
            
            startAnnouncementSlider(total) {
                if (this.announcementSliderInterval) clearInterval(this.announcementSliderInterval);
                this.announcementSliderInterval = setInterval(() => {
                    this.currentAnnouncementIndex = (this.currentAnnouncementIndex + 1) % total;
                    this.goToAnnouncement(this.currentAnnouncementIndex);
                }, 5000); // Change every 5 seconds
            },
            
            goToAnnouncement(index) {
                this.currentAnnouncementIndex = index;
                // Update slides
                document.querySelectorAll('.announcement-slide').forEach((slide, i) => {
                    slide.classList.toggle('active', i === index);
                });
                // Update dots
                document.querySelectorAll('.announcement-dot').forEach((dot, i) => {
                    dot.classList.toggle('active', i === index);
                });
            },
            
            loadPlayer() {
                const saved = localStorage.getItem('rs_player');
                if (saved) { this.player = JSON.parse(saved); document.getElementById('player-name').value = this.player.name || ''; document.getElementById('player-phone').value = this.player.phone || ''; }
            },
            
            loadStats() {
                this.gamesPlayed = parseInt(localStorage.getItem('rs_games') || '0');
                this.bestScore = parseInt(localStorage.getItem('rs_best') || '0');
                document.getElementById('games-played-stat').textContent = this.gamesPlayed;
                document.getElementById('best-score-stat').textContent = this.bestScore;
                document.getElementById('achievements-stat').textContent = Object.keys(this.achievements).length + '/8';
            },
            
            loadAchievements() { const saved = localStorage.getItem('rs_achievements'); this.achievements = saved ? JSON.parse(saved) : {}; this.updateAchievementsUI(); },
            saveAchievements() { localStorage.setItem('rs_achievements', JSON.stringify(this.achievements)); document.getElementById('achievements-stat').textContent = Object.keys(this.achievements).length + '/8'; },
            
            unlockAchievement(id, name) {
                if (this.achievements[id]) return;
                this.achievements[id] = true; this.saveAchievements();
                document.getElementById('achievement-text').textContent = name;
                const popup = document.getElementById('achievement-popup'); popup.classList.add('show'); setTimeout(() => popup.classList.remove('show'), 3000);
                this.updateAchievementsUI();
            },
            
            updateAchievementsUI() { document.querySelectorAll('.achievement-badge').forEach(b => { if (this.achievements[b.dataset.id]) b.classList.add('unlocked'); }); },
            
            currentLeaderboardPeriod: 'today',
            leaderboardInterval: null,
            
            async loadLeaderboard(period = null) {
                if (period) {
                    this.currentLeaderboardPeriod = period;
                    // Update tabs UI
                    document.querySelectorAll('.lb-tab').forEach(t => {
                        t.classList.toggle('active', t.dataset.period === period);
                    });
                }
                
                try {
                    const res = await fetch(`/api/leaderboard?period=${this.currentLeaderboardPeriod}`);
                    const result = await res.json();
                    const data = result.leaderboard || result || [];
                    const container = document.getElementById('leaderboard-list');
                    
                    if (!data || data.length === 0) {
                        container.innerHTML = '<div class="leaderboard-item"><div class="rank">-</div><div class="player-info"><div class="player-name" style="color:#888;">   </div></div></div>';
                        return;
                    }
                    
                    const myPhone = this.player?.phone;
                    
                    container.innerHTML = data.slice(0, 10).map((p, i) => {
                        const isMe = myPhone && p.phone === myPhone;
                        const rankClass = i === 0 ? 'first' : i === 1 ? 'second' : i === 2 ? 'third' : '';
                        const itemClass = (i === 0 ? 'gold ' : '') + (isMe ? 'me' : '');
                        
                        return `
                            <div class="leaderboard-item ${itemClass}">
                                <div class="rank ${rankClass}">${i === 0 ? '' : i + 1}</div>
                                <div class="player-info">
                                    <div class="player-name">${p.name} ${isMe ? '()' : ''}</div>
                                    <div class="player-province">${p.province}</div>
                                </div>
                                <div class="player-score">${this.formatNumber(p.score)}</div>
                            </div>
                        `;
                    }).join('');
                } catch (err) {
                    console.error('Leaderboard error:', err);
                }
            },
            
            formatNumber(num) {
                if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
                if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
                return num.toString();
            },
            
            startLeaderboardUpdates() {
                this.stopLeaderboardUpdates();
                this.leaderboardInterval = setInterval(() => {
                    this.loadLeaderboard();
                }, 30000); // Update every 30 seconds
            },
            
            stopLeaderboardUpdates() {
                if (this.leaderboardInterval) {
                    clearInterval(this.leaderboardInterval);
                    this.leaderboardInterval = null;
                }
            },
            
            setupProvinces() {
                const provinces = ['', '', '', '', '', '', '', ' ', '', '', '', ' ', '', '', '', '', '', ''];
                const select = document.getElementById('player-province');
                provinces.forEach(p => { const opt = document.createElement('option'); opt.value = p; opt.textContent = p; select.appendChild(opt); });
                if (this.player?.province) select.value = this.player.province;
            },
            
            setupForm() {
                document.getElementById('register-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const name = document.getElementById('player-name').value.trim();
                    const province = document.getElementById('player-province').value;
                    const phone = document.getElementById('player-phone').value.replace(/\D/g, '');
                    if (!name || !province || phone.length < 10) { this.showToast('     ', true); return; }
                    this.player = { name, province, phone }; localStorage.setItem('rs_player', JSON.stringify(this.player));
                    try { const session = await API.startSession(phone); if (session && !session.error) { this.sessionId = session.sessionId; this.currentRound = session.round || 1; this.totalScore = session.totalScore || 0; this.difficultyLevel = session.difficultyLevel || 0; } } catch (err) {}
                    this.updateLastPlayed(); // Update last played date
                    this.showScreen('game'); this.initGame();
                });
            },
            
            setupTouch() {
                const container = document.getElementById('game-container');
                let startX, startY, startTime;
                let touchMoved = false;
                const SWIPE_THRESHOLD = 30;
                const TAP_THRESHOLD = 200;
                const DOUBLE_TAP_THRESHOLD = 300;
                let lastTap = 0;
                
                container.addEventListener('touchstart', (e) => {
                    if (!this.gameActive) return;
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                    startTime = Date.now();
                    touchMoved = false;
                }, { passive: true });
                
                container.addEventListener('touchmove', (e) => {
                    if (!this.gameActive) return;
                    e.preventDefault();
                    
                    const currentX = e.touches[0].clientX;
                    const currentY = e.touches[0].clientY;
                    const dx = currentX - startX;
                    const dy = currentY - startY;
                    
                    // Horizontal swipe
                    if (Math.abs(dx) > SWIPE_THRESHOLD) {
                        this.move(dx > 0 ? 1 : -1);
                        startX = currentX;
                        touchMoved = true;
                    }
                    
                    // Swipe down for soft drop
                    if (dy > SWIPE_THRESHOLD) {
                        this.drop();
                        startY = currentY;
                        touchMoved = true;
                    }
                    
                    // Swipe up for hard drop
                    if (dy < -SWIPE_THRESHOLD * 2) {
                        this.hardDrop();
                        startY = currentY;
                        touchMoved = true;
                    }
                }, { passive: false });
                
                container.addEventListener('touchend', (e) => {
                    if (!this.gameActive) return;
                    
                    const now = Date.now();
                    const duration = now - startTime;
                    
                    // Single tap = rotate only (no hard drop)
                    if (!touchMoved && duration < TAP_THRESHOLD) {
                        this.rotate();
                    }
                });
                
                // Add visual touch buttons for mobile
                this.setupMobileButtons();
            },
            
            setupMobileButtons() {
                // Removed - not needed
            },
            
            setupKeyboard() {
                document.addEventListener('keydown', (e) => {
                    if (!this.gameActive) return;
                    switch(e.key) { 
                        case 'ArrowLeft': this.move(-1); break; 
                        case 'ArrowRight': this.move(1); break; 
                        case 'ArrowDown': this.drop(); break; 
                        case 'ArrowUp': this.rotate(); break; 
                        case ' ': this.hardDrop(); break;
                        case 'h': case 'H': case 'Shift': case 'c': case 'C': this.holdCurrentPiece(); break;
                        case 'p': case 'P': this.pause(); break;
                    }
                    if (['ArrowUp','ArrowDown','ArrowLeft','ArrowRight',' '].includes(e.key)) e.preventDefault();
                });
            },
            
            showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id + '-screen').classList.add('active'); },
            showToast(msg, isError = false) { const toast = document.getElementById('toast'); toast.textContent = msg; toast.style.background = isError ? '#e31e24' : '#1a237e'; toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), 3000); },
            checkWin() { window.location.href = '/check.html'; },
            
            // Notification System
            notificationType: null,
            
            showNotification(type, icon, text, btnText) {
                const banner = document.getElementById('notification-banner');
                const iconEl = document.getElementById('notification-icon');
                const textEl = document.getElementById('notification-text');
                const btnEl = document.getElementById('notification-btn');
                
                this.notificationType = type;
                iconEl.textContent = icon;
                textEl.textContent = text;
                btnEl.textContent = btnText;
                
                banner.className = 'notification-banner ' + type;
                setTimeout(() => banner.classList.add('show'), 100);
                
                // Auto hide after 10 seconds
                setTimeout(() => this.hideNotification(), 10000);
            },
            
            hideNotification() {
                document.getElementById('notification-banner').classList.remove('show');
            },
            
            handleNotificationAction() {
                this.hideNotification();
                if (this.notificationType === 'win') {
                    this.checkWin();
                } else if (this.notificationType === 'reminder') {
                    // Scroll to form and focus
                    document.getElementById('player-name').focus();
                    document.getElementById('home-screen').scrollTo({ top: 0, behavior: 'smooth' });
                }
            },
            
            // Check for daily reminder
            checkDailyReminder() {
                const lastPlayed = localStorage.getItem('rs_last_played');
                const today = new Date().toDateString();
                
                if (lastPlayed && lastPlayed !== today) {
                    // Played before but not today
                    const daysSince = Math.floor((new Date() - new Date(lastPlayed)) / (1000 * 60 * 60 * 24));
                    if (daysSince >= 1) {
                        setTimeout(() => {
                            this.showNotification('reminder', '', '!      ', ' ');
                        }, 2000);
                    }
                }
            },
            
            // Check for win notification
            async checkWinNotification() {
                try {
                    const phone = this.player?.phone;
                    if (!phone) return;
                    
                    const res = await fetch('/api/coupons/check/' + phone);
                    const data = await res.json();
                    
                    if (data.winner && data.coupons && data.coupons.length > 0) {
                        const unusedCoupons = data.coupons.filter(c => !c.is_used);
                        if (unusedCoupons.length > 0) {
                            setTimeout(() => {
                                this.showNotification('win', '', '!  ' + unusedCoupons.length + '  !', ' ');
                            }, 3000);
                        }
                    }
                } catch (e) {
                    console.log('Could not check win status');
                }
            },
            
            // Update last played date
            updateLastPlayed() {
                localStorage.setItem('rs_last_played', new Date().toDateString());
            },
            
            initGame() {
                const container = document.getElementById('game-container');
                
                const setupGame = () => {
                    const containerRect = container.getBoundingClientRect();
                    const maxHeight = containerRect.height - 10;
                    const maxWidth = containerRect.width - 10;
                    
                    // If container not ready, retry
                    if (maxHeight < 100 || maxWidth < 50) {
                        setTimeout(setupGame, 100);
                        return;
                    }
                    
                    this.BLOCK_SIZE = Math.floor(Math.min(maxHeight / this.ROWS, maxWidth / this.COLS));
                    if (this.BLOCK_SIZE < 10) this.BLOCK_SIZE = 15;
                    this.canvas.width = this.COLS * this.BLOCK_SIZE;
                    this.canvas.height = this.ROWS * this.BLOCK_SIZE;
                    this.board = Array(this.ROWS).fill().map(() => Array(this.COLS).fill(0));
                    this.score = 0; this.level = 1; this.lines = 0; this.combo = 0; this.multiplier = 1; this.energy = 0; this.powerUpReady = false; this.timeRemaining = 180;
                    this.holdPiece = null; this.canHold = true; this.drawHoldPiece();
                    const diffMultiplier = 1 - (this.difficultyLevel / 100); this.dropInterval = Math.max(400, 1000 * diffMultiplier);
                    this.nextPiece = this.createPiece(); this.spawnPiece();
                    this.updateUI(); document.getElementById('round-display').textContent = this.currentRound + '/' + this.maxRounds;
                    document.getElementById('overlay-title').textContent = ''; document.getElementById('overlay-subtitle').textContent = ' ' + this.currentRound;
                    document.getElementById('overlay-btn').textContent = ''; document.getElementById('overlay-btn').onclick = () => Game.start();
                    document.getElementById('game-overlay').classList.remove('hidden'); this.draw();
                };
                
                setTimeout(setupGame, 150);
            },
            
            start() {
                document.getElementById('game-overlay').classList.add('hidden'); this.gameActive = true; this.isPaused = false;
                this.unlockAchievement('first_game', '  !');
                this.timerInterval = setInterval(() => this.updateTimer(), 1000);
                this.lastDrop = performance.now(); this.loop();
            },
            
            loop() { if (!this.gameActive || this.isPaused) return; const now = performance.now(); if (now - this.lastDrop > this.dropInterval) { this.moveDown(); this.lastDrop = now; } this.draw(); this.animationId = requestAnimationFrame(() => this.loop()); },
            
            pause() {
                if (!this.gameActive) return; this.isPaused = !this.isPaused;
                if (this.isPaused) { document.getElementById('overlay-title').textContent = ' '; document.getElementById('overlay-subtitle').textContent = ' '; document.getElementById('overlay-btn').textContent = ''; document.getElementById('overlay-btn').onclick = () => this.resume(); document.getElementById('game-overlay').classList.remove('hidden'); }
            },
            
            resume() { this.isPaused = false; document.getElementById('game-overlay').classList.add('hidden'); this.loop(); },
            
            updateTimer() {
                if (this.isPaused) return; this.timeRemaining--;
                const mins = Math.floor(this.timeRemaining / 60); const secs = this.timeRemaining % 60;
                const display = document.getElementById('timer-display'); display.textContent = mins + ':' + secs.toString().padStart(2, '0');
                if (this.timeRemaining <= 30) display.classList.add('warning');
                if (this.timeRemaining <= 0) this.endGame();
            },
            
            createPiece() { 
                const type = Math.floor(Math.random() * 7) + 1; 
                return { type, shape: this.SHAPES[type].map(row => [...row]), x: Math.floor(this.COLS / 2) - 1, y: 0 }; 
            },
            
            spawnPiece() { 
                this.currentPiece = this.nextPiece; 
                this.nextPiece = this.createPiece(); 
                this.drawNextPiece(); 
                if (this.collision()) this.endGame(); 
            },
            
            drawNextPiece() {
                this.nextCtx.fillStyle = 'rgba(26,35,126,0.1)'; this.nextCtx.fillRect(0, 0, 45, 45);
                const piece = this.nextPiece; const size = 9;
                const offsetX = (45 - piece.shape[0].length * size) / 2; const offsetY = (45 - piece.shape.length * size) / 2;
                piece.shape.forEach((row, y) => { row.forEach((val, x) => { if (val) { this.nextCtx.fillStyle = this.COLORS[val]; this.nextCtx.fillRect(offsetX + x * size, offsetY + y * size, size - 1, size - 1); } }); });
            },
            
            // Hold Piece System
            holdCurrentPiece() {
                if (!this.canHold || !this.gameActive) return;
                
                this.playSound('rotate');
                
                if (this.holdPiece === null) {
                    // First hold - store current piece and get new one
                    this.holdPiece = { type: this.currentPiece.type, shape: this.SHAPES[this.currentPiece.type].map(row => [...row]) };
                    this.spawnPiece();
                } else {
                    // Swap current with held piece
                    const tempType = this.currentPiece.type;
                    this.currentPiece = {
                        type: this.holdPiece.type,
                        shape: this.SHAPES[this.holdPiece.type].map(row => [...row]),
                        x: Math.floor(this.COLS / 2) - 1,
                        y: 0
                    };
                    this.holdPiece = { type: tempType, shape: this.SHAPES[tempType].map(row => [...row]) };
                }
                
                this.canHold = false; // Can't hold again until piece locks
                this.drawHoldPiece();
            },
            
            drawHoldPiece() {
                if (!this.holdCtx) return;
                
                this.holdCtx.fillStyle = 'rgba(26,35,126,0.1)';
                this.holdCtx.fillRect(0, 0, 45, 45);
                
                if (!this.holdPiece) return;
                
                const piece = this.holdPiece;
                const size = 9;
                const offsetX = (45 - piece.shape[0].length * size) / 2;
                const offsetY = (45 - piece.shape.length * size) / 2;
                
                // Dim if can't hold
                const alpha = this.canHold ? 1 : 0.4;
                
                piece.shape.forEach((row, y) => {
                    row.forEach((val, x) => {
                        if (val) {
                            this.holdCtx.globalAlpha = alpha;
                            this.holdCtx.fillStyle = this.COLORS[piece.type];
                            this.holdCtx.fillRect(offsetX + x * size, offsetY + y * size, size - 1, size - 1);
                            this.holdCtx.globalAlpha = 1;
                        }
                    });
                });
            },
            
            move(dir) { this.currentPiece.x += dir; if (this.collision()) this.currentPiece.x -= dir; else this.playSound('move'); },
            rotate() { const shape = this.currentPiece.shape; const rotated = shape[0].map((_, i) => shape.map(row => row[i]).reverse()); const original = this.currentPiece.shape; this.currentPiece.shape = rotated; if (this.collision()) this.currentPiece.shape = original; else this.playSound('rotate'); },
            drop() { this.currentPiece.y++; if (this.collision()) { this.currentPiece.y--; this.lockPiece(); } },
            hardDrop() { let dist = 0; while (!this.collision()) { this.currentPiece.y++; dist++; } this.currentPiece.y--; if (dist > 0) this.score += dist * 2; this.playSound('drop'); this.lockPiece(); },
            moveDown() { this.currentPiece.y++; if (this.collision()) { this.currentPiece.y--; this.lockPiece(); } },
            
            collision() {
                const { shape, x, y } = this.currentPiece;
                for (let py = 0; py < shape.length; py++) { for (let px = 0; px < shape[py].length; px++) { if (shape[py][px]) { const newX = x + px; const newY = y + py; if (newX < 0 || newX >= this.COLS || newY >= this.ROWS) return true; if (newY >= 0 && this.board[newY][newX]) return true; } } }
                return false;
            },
            
            lockPiece() { 
                const { shape, x, y, type } = this.currentPiece; 
                shape.forEach((row, py) => { 
                    row.forEach((val, px) => { 
                        if (val && y + py >= 0) this.board[y + py][x + px] = type; 
                    }); 
                }); 
                this.canHold = true; // Allow holding again
                this.drawHoldPiece(); // Update hold display
                this.clearLines(); 
                this.spawnPiece(); 
            },
            
            clearLines() {
                let cleared = 0;
                let clearedRows = [];
                
                for (let y = this.ROWS - 1; y >= 0; y--) { 
                    if (this.board[y].every(cell => cell)) { 
                        clearedRows.push(y);
                        this.board.splice(y, 1); 
                        this.board.unshift(Array(this.COLS).fill(0)); 
                        cleared++; 
                        y++; 
                    } 
                }
                
                if (cleared > 0) {
                    const now = Date.now();
                    
                    //  CREATE PARTICLE EFFECTS
                    const gameRect = this.canvas.getBoundingClientRect();
                    clearedRows.forEach(row => {
                        const y = gameRect.top + row * this.BLOCK_SIZE + this.BLOCK_SIZE / 2;
                        ParticleSystem.createLineClear(y, gameRect.width, this.BLOCK_SIZE);
                    });
                    
                    // Extra sparkles for Tetris (4 lines)
                    if (cleared === 4) {
                        const centerX = gameRect.left + gameRect.width / 2;
                        const centerY = gameRect.top + gameRect.height / 2;
                        ParticleSystem.createExplosion(centerX, centerY, '#ffd700', 40);
                        ParticleSystem.createSparkles(centerX, centerY, 30);
                        // Vibrate if available
                        if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                    }
                    
                    // Combo system - 2 second window
                    if (now - this.lastClearTime < 2000) {
                        this.combo++;
                        this.playSound('combo');
                    } else {
                        this.combo = 1;
                    }
                    this.lastClearTime = now;
                    
                    // Calculate points with combo bonus
                    const basePoints = [0, 100, 300, 500, 800][cleared];
                    const comboBonus = Math.floor(basePoints * (this.combo - 1) * 0.15);
                    const points = (basePoints + comboBonus) * this.level;
                    
                    this.score += points;
                    this.lines += cleared;
                    
                    const oldLevel = this.level;
                    this.level = Math.floor(this.lines / 10) + 1;
                    if (this.level > oldLevel) {
                        this.playSound('levelUp');
                        // Level up particles
                        const gameRect = this.canvas.getBoundingClientRect();
                        ParticleSystem.createExplosion(gameRect.left + gameRect.width/2, gameRect.top + gameRect.height/2, '#4caf50', 30);
                    }
                    
                    const diffMultiplier = 1 - (this.difficultyLevel / 100);
                    this.dropInterval = Math.max(100, (1000 - (this.level - 1) * 80) * diffMultiplier);
                    
                    // Show combo and play sound
                    if (this.combo > 1) {
                        this.showCombo(this.combo, comboBonus);
                        this.multiplier = Math.min(5, 1 + Math.floor(this.combo / 2));
                    }
                    
                    // Sound for lines
                    if (cleared === 4) {
                        this.playSound('tetris');
                    } else {
                        this.playSound('clear');
                    }
                    
                    this.energy = Math.min(100, this.energy + cleared * 15);
                    if (this.energy >= 100 && !this.powerUpReady) { this.powerUpReady = true; this.unlockAchievement('power_up', '  !'); }
                    this.createBubbles(cleared * 3);
                    
                    if (this.score >= 1000) this.unlockAchievement('score_1000', ' 1000 !');
                    if (this.score >= 5000) this.unlockAchievement('score_5000', ' 5000 !');
                    if (this.combo >= 3) this.unlockAchievement('combo_3', '  x3!');
                    if (this.lines >= 10) this.unlockAchievement('lines_10', ' 10 !');
                    this.updateUI();
                } else {
                    this.combo = 0;
                    this.multiplier = 1;
                    document.getElementById('multiplier-display').textContent = '1x';
                }
            },
            
            showCombo(combo, bonus) {
                const popup = document.getElementById('combo-popup');
                if (popup && combo > 1) {
                    // Motivational messages based on combo level
                    const messages = {
                        2: ['! ', '! ', '! '],
                        3: ['! ', '! ', '! '],
                        4: [' ! ', '! ', '! '],
                        5: ['! ', ' ! ', ' ! ']
                    };
                    
                    const level = Math.min(combo, 5);
                    const msgArray = messages[level] || messages[5];
                    const randomMsg = msgArray[Math.floor(Math.random() * msgArray.length)];
                    
                    popup.innerHTML = `<div class="combo-text">COMBO x${combo}</div><div class="combo-msg">${randomMsg}</div>`;
                    
                    // Remove and re-add class to restart animation
                    popup.classList.remove('show');
                    void popup.offsetWidth; // Force reflow
                    popup.classList.add('show');
                    
                    // Vibrate for high combos
                    if (navigator.vibrate && combo >= 3) {
                        navigator.vibrate([50, 30, 50]);
                    }
                }
                document.getElementById('multiplier-display').textContent = this.multiplier + 'x';
            },
            
            createBubbles(count) { const container = document.getElementById('bubbles-container'); for (let i = 0; i < count; i++) { const bubble = document.createElement('div'); bubble.className = 'bubble'; bubble.style.left = Math.random() * 100 + '%'; bubble.style.width = bubble.style.height = (10 + Math.random() * 20) + 'px'; bubble.style.animationDelay = (Math.random() * 0.5) + 's'; container.appendChild(bubble); setTimeout(() => bubble.remove(), 2000); } },
            
            // Power-ups Functions
            usePowerUp() {
                if (!this.powerUpReady || !this.gameActive) return;
                this.showPowerUpMenu();
            },
            
            showPowerUpMenu() {
                this.pause();
                const menu = document.getElementById('powerup-menu');
                if (menu) {
                    document.getElementById('menu-energy').textContent = this.energy;
                    this.updatePowerUpMenu();
                    menu.classList.remove('hidden');
                }
            },
            
            hidePowerUpMenu() {
                const menu = document.getElementById('powerup-menu');
                if (menu) menu.classList.add('hidden');
                this.resume();
            },
            
            updatePowerUpMenu() {
                const container = document.getElementById('powerup-list');
                if (!container) return;
                
                container.innerHTML = Object.entries(this.powerUps).map(([key, pu]) => `
                    <div class="powerup-item ${this.energy >= pu.cost ? '' : 'disabled'}" onclick="Game.activatePowerUp('${key}')">
                        <span class="powerup-icon">${pu.icon}</span>
                        <div class="powerup-info">
                            <div class="powerup-name">${pu.name}</div>
                            <div class="powerup-desc">${pu.description}</div>
                        </div>
                        <div class="powerup-cost">${pu.cost} </div>
                    </div>
                `).join('');
            },
            
            activatePowerUp(type) {
                const pu = this.powerUps[type];
                if (!pu || this.energy < pu.cost) {
                    this.showToast('  !', true);
                    return;
                }
                
                this.energy -= pu.cost;
                if (this.energy < 100) this.powerUpReady = false;
                this.hidePowerUpMenu();
                
                switch(type) {
                    case 'bomb':
                        // Remove bottom 3 rows
                        for (let i = 0; i < 3; i++) {
                            this.board.pop();
                            this.board.unshift(Array(this.COLS).fill(0));
                        }
                        this.score += 300;
                        this.createBubbles(15);
                        this.playSound('tetris');
                        this.showToast(' 3  ! +300');
                        break;
                        
                    case 'freeze':
                        // Slow down for 10 seconds
                        this.slowMotion = true;
                        const originalInterval = this.dropInterval;
                        this.dropInterval = this.dropInterval * 3;
                        this.showToast('  10 !');
                        setTimeout(() => {
                            this.slowMotion = false;
                            this.dropInterval = originalInterval;
                            this.showToast('  ');
                        }, 10000);
                        break;
                        
                    case 'shuffle':
                        // Clear random blocks
                        for (let y = 0; y < this.ROWS; y++) {
                            for (let x = 0; x < this.COLS; x++) {
                                if (this.board[y][x] && Math.random() > 0.5) {
                                    this.board[y][x] = 0;
                                }
                            }
                        }
                        this.score += 100;
                        this.createBubbles(10);
                        this.showToast('  ! +100');
                        break;
                        
                    case 'ghost':
                        // Wall pass for 15 seconds
                        this.wallPass = true;
                        this.showToast('   15 !');
                        setTimeout(() => {
                            this.wallPass = false;
                            // Fix piece position if outside
                            while (this.currentPiece.x < 0) this.currentPiece.x++;
                            while (this.currentPiece.x + this.currentPiece.shape[0].length > this.COLS) this.currentPiece.x--;
                            this.showToast('   ');
                        }, 15000);
                        break;
                }
                
                this.updateUI();
            },
            
            // Theme Functions
            loadTheme() {
                this.currentTheme = localStorage.getItem('gameTheme') || 'classic';
                this.applyTheme();
            },
            
            applyTheme() {
                const theme = this.themes[this.currentTheme];
                if (theme) {
                    this.COLORS = theme.colors;
                }
            },
            
            setTheme(themeName) {
                if (this.themes[themeName]) {
                    this.currentTheme = themeName;
                    localStorage.setItem('gameTheme', themeName);
                    this.applyTheme();
                    this.showToast(` : ${this.themes[themeName].name}`);
                    if (this.gameActive) this.draw();
                }
            },
            
            showThemeSelector() {
                const selector = document.getElementById('theme-selector');
                if (selector) {
                    selector.innerHTML = Object.entries(this.themes).map(([key, theme]) => `
                        <div class="theme-option ${this.currentTheme === key ? 'active' : ''}" onclick="Game.setTheme('${key}')">
                            <div class="theme-preview" style="background: ${theme.bg};">
                                ${theme.colors.slice(1, 5).map(c => `<span style="background:${c};"></span>`).join('')}
                            </div>
                            <div class="theme-name">${theme.name}</div>
                        </div>
                    `).join('');
                    selector.classList.toggle('hidden');
                }
            },
            
            updateUI() { document.getElementById('score-display').textContent = this.score; document.getElementById('level-display').textContent = this.level; document.getElementById('lines-display').textContent = this.lines; document.getElementById('energy-fill').style.height = this.energy + '%'; const powerIcon = document.getElementById('power-icon'); if (this.powerUpReady) powerIcon.classList.add('active'); else powerIcon.classList.remove('active'); },
            
            draw() {
                const { ctx, canvas, BLOCK_SIZE } = this;
                const theme = this.themes[this.currentTheme];
                
                // Background
                ctx.fillStyle = theme.bg;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Grid
                ctx.strokeStyle = theme.grid;
                ctx.lineWidth = 1;
                for (let x = 0; x <= this.COLS; x++) { ctx.beginPath(); ctx.moveTo(x * BLOCK_SIZE, 0); ctx.lineTo(x * BLOCK_SIZE, canvas.height); ctx.stroke(); }
                for (let y = 0; y <= this.ROWS; y++) { ctx.beginPath(); ctx.moveTo(0, y * BLOCK_SIZE); ctx.lineTo(canvas.width, y * BLOCK_SIZE); ctx.stroke(); }
                
                // Board blocks - pass type for product images
                this.board.forEach((row, y) => { row.forEach((val, x) => { if (val) this.drawBlock(x, y, this.COLORS[val]); }); });
                
                // Slow motion effect
                if (this.slowMotion) {
                    ctx.fillStyle = 'rgba(100,200,255,0.1)';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                }
                
                // Ghost piece
                if (this.currentPiece && this.ghostEnabled) {
                    const ghostY = this.getGhostY();
                    const { shape, x, type } = this.currentPiece;
                    shape.forEach((row, py) => { row.forEach((val, px) => { if (val) this.drawGhostBlock(x + px, ghostY + py); }); });
                }
                
                // Wall pass effect
                if (this.wallPass && this.currentPiece) {
                    ctx.strokeStyle = 'rgba(150,100,255,0.5)';
                    ctx.lineWidth = 3;
                    ctx.setLineDash([5, 5]);
                    ctx.strokeRect(0, 0, canvas.width, canvas.height);
                    ctx.setLineDash([]);
                }
                
                // Current piece
                if (this.currentPiece) { 
                    const { shape, x, y, type } = this.currentPiece;
                    shape.forEach((row, py) => { 
                        row.forEach((val, px) => { 
                            if (val) this.drawBlock(x + px, y + py, this.COLORS[type]); 
                        }); 
                    });
                }
            },
            
            getGhostY() {
                let ghostY = this.currentPiece.y;
                while (!this.collisionAt(this.currentPiece.x, ghostY + 1, this.currentPiece.shape)) {
                    ghostY++;
                }
                return ghostY;
            },
            
            collisionAt(px, py, shape) {
                for (let y = 0; y < shape.length; y++) {
                    for (let x = 0; x < shape[y].length; x++) {
                        if (shape[y][x]) {
                            const nx = px + x;
                            const ny = py + y;
                            if (nx < 0 || nx >= this.COLS || ny >= this.ROWS) return true;
                            if (ny >= 0 && this.board[ny][nx]) return true;
                        }
                    }
                }
                return false;
            },
            
            drawBlock(x, y, color, type = 0) {
                const { ctx, BLOCK_SIZE } = this; const padding = 2;
                
                // Normal colored block
                ctx.fillStyle = color;
                ctx.fillRect(x * BLOCK_SIZE + padding, y * BLOCK_SIZE + padding, BLOCK_SIZE - padding * 2, BLOCK_SIZE - padding * 2);
                ctx.fillStyle = 'rgba(255,255,255,0.35)';
                ctx.fillRect(x * BLOCK_SIZE + padding, y * BLOCK_SIZE + padding, BLOCK_SIZE - padding * 2, 4);
                ctx.strokeStyle = 'rgba(0,0,0,0.15)';
                ctx.lineWidth = 1;
                ctx.strokeRect(x * BLOCK_SIZE + padding, y * BLOCK_SIZE + padding, BLOCK_SIZE - padding * 2, BLOCK_SIZE - padding * 2);
            },
            
            drawGhostBlock(x, y) {
                const { ctx, BLOCK_SIZE } = this; const padding = 3;
                ctx.strokeStyle = 'rgba(26,35,126,0.4)';
                ctx.lineWidth = 2;
                ctx.setLineDash([4, 4]);
                ctx.strokeRect(x * BLOCK_SIZE + padding, y * BLOCK_SIZE + padding, BLOCK_SIZE - padding * 2, BLOCK_SIZE - padding * 2);
                ctx.setLineDash([]);
                ctx.lineWidth = 1;
            },
            
            endGame() {
                this.gameActive = false; clearInterval(this.timerInterval); cancelAnimationFrame(this.animationId);
                this.playSound('gameOver');
                this.gamesPlayed++; localStorage.setItem('rs_games', this.gamesPlayed);
                if (this.score > this.bestScore) { this.bestScore = this.score; localStorage.setItem('rs_best', this.bestScore); }
                if (this.gamesPlayed >= 5) this.unlockAchievement('games_5', ' 5 !');
                if (this.gamesPlayed >= 10) this.unlockAchievement('games_10', ' 10 !');
                const comboBonus = Math.floor(this.score * (this.multiplier - 1) * 0.1); const finalScore = this.score + comboBonus; this.totalScore += finalScore;
                document.getElementById('round-score').textContent = this.score; document.getElementById('combo-bonus').textContent = comboBonus; document.getElementById('final-score').textContent = this.totalScore;
                if (this.currentRound >= this.maxRounds) { document.getElementById('gameover-icon').textContent = ''; document.getElementById('gameover-title').textContent = '  !'; document.getElementById('next-round-info').style.display = 'none'; document.getElementById('next-round-btn').style.display = 'none'; }
                else { document.getElementById('gameover-icon').textContent = ''; document.getElementById('gameover-title').textContent = ' !'; document.getElementById('next-round-info').style.display = 'block'; document.getElementById('next-round-btn').style.display = 'block'; document.getElementById('next-difficulty').textContent = [20, 40, 50][this.currentRound] + '%'; }
                if (this.player) fetch('/api/submit-score', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ phone: this.player.phone, score: this.totalScore }) }).catch(() => {});
                this.showScreen('gameover');
            },
            
            nextRound() { this.currentRound++; this.difficultyLevel = [0, 20, 40, 50][Math.min(this.currentRound - 1, 3)]; this.showScreen('game'); this.initGame(); },
            exit() { if (this.gameActive) { if (!confirm('  ')) return; this.endGame(); } this.goHome(); },
            goHome() { this.currentRound = 1; this.totalScore = 0; this.difficultyLevel = 0; this.loadStats(); this.loadLeaderboard(); this.showScreen('home'); },
            share() { const text = '  Red Strong Tetris   ' + this.totalScore + ' ! \n\n    ! \n' + window.location.origin; window.open('https://wa.me/?text=' + encodeURIComponent(text), '_blank'); },
            
            // Themes functions
            openThemes() {
                const modal = document.getElementById('themes-modal');
                modal.classList.add('active');
                const playerPoints = parseInt(localStorage.getItem('rs_total_score') || '0');
                themesManager.renderSelector(document.getElementById('themes-container'), playerPoints);
            },
            closeThemes() {
                document.getElementById('themes-modal').classList.remove('active');
            },
            getBlockColor(type) {
                return themesManager.getBlockColor(type);
            }
        };
        
        // Override block colors to use theme
        window.addEventListener('load', () => {
            Game.init();
            themesManager.apply();
        });
    </script>
    
    <!-- Themes Modal -->
    <div class="themes-modal" id="themes-modal">
        <div class="themes-modal-content">
            <div class="themes-modal-header">
                <h3> 